<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title ? title + ' - ' : '' %><%= appName %></title>
    
    <!-- Custom CSS -->
    <link href="/css/app.css" rel="stylesheet">
    <link href="/css/layout.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
</head>
<body class="app-auth">
    <div class="app-layout">
        <% const userRoleName = user && (user.role_name || user.roleName); %>
        <% const isAdminView = userRoleName && userRoleName.toString().toLowerCase() === 'admin'; %>
        <!-- Sidebar Navigation -->
        <aside class="app-sidebar" id="appSidebar">
            <div class="sidebar-brand">
                <div class="sidebar-brand__logo">üèõÔ∏è</div>
                <div class="sidebar-brand__text">
                    <div class="brand-title">qu·∫£n l√Ω gi√°o v·ª• Khoa</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <p class="section-label">T·ªîNG QUAN</p>
                    <a class="sidebar-link <%= currentPath === '/dashboard' ? 'active' : '' %>" href="/dashboard">
                        <i class="fa fa-home">üè†</i>
                        <span>Trang ch·ªß</span>
                    </a>
                </div>

                <div class="sidebar-section">
                    <p class="section-label">QU·∫¢N L√ù H√ÄNH CH√çNH</p>
                    <% if (isAdminView) { %>
                    <a class="sidebar-link <%= currentPath.startsWith('/users') ? 'active' : '' %>" href="/users">
                        <i class="fa fa-user-shield">üõ°Ô∏è</i>
                        <span>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</span>
                    </a>
                    <% } %>
                    <a class="sidebar-link <%= currentPath.startsWith('/documents') ? 'active' : '' %>" href="/documents">
                        <i class="fa fa-file-text">üìÑ</i>
                        <span>Qu·∫£n l√Ω vƒÉn b·∫£n</span>
                    </a>
                    <a class="sidebar-link <%= currentPath.startsWith('/legal-documents') ? 'active' : '' %>" href="/legal-documents">
                        <i class="fa fa-gavel">‚öñÔ∏è</i>
                        <span>VƒÉn b·∫£n ph√°p l√Ω</span>
                    </a>
                    <a class="sidebar-link <%= currentPath.startsWith('/staff') ? 'active' : '' %>" href="/staff">
                        <i class="fa fa-users">üë•</i>
                        <span>Qu·∫£n l√Ω c√°n b·ªô</span>
                    </a>
                    <a class="sidebar-link <%= currentPath.startsWith('/assets') ? 'active' : '' %>" href="/assets">
                        <i class="fa fa-building">üè¢</i>
                        <span>Qu·∫£n l√Ω t√†i s·∫£n</span>
                    </a>
                </div>

                <div class="sidebar-section">
                    <p class="section-label">NGHI·ªÜP V·ª§ GI·∫¢NG D·∫†Y</p>
                    <a class="sidebar-link <%= currentPath.startsWith('/examination') ? 'active' : '' %>" href="/examination">
                        <i class="fa fa-clipboard-check">üìã</i>
                        <span>C√¥ng t√°c kh·∫£o th√≠</span>
                    </a>
                    <a class="sidebar-link <%= currentPath.startsWith('/teaching-handbook') ? 'active' : '' %>" href="/teaching-handbook">
                        <i class="fa fa-book">üìö</i>
                        <span>S·ªï tay c√¥ng t√°c</span>
                    </a>
                </div>

                <div class="sidebar-section">
                    <p class="section-label">NGHI√äN C·ª®U & D·ª∞ √ÅN</p>
                    <a class="sidebar-link <%= currentPath.startsWith('/research') ? 'active' : '' %>" href="/research">
                        <i class="fa fa-flask">üß™</i>
                        <span>Nghi√™n c·ª©u khoa h·ªçc</span>
                    </a>
                    <a class="sidebar-link <%= currentPath.startsWith('/projects') ? 'active' : '' %>" href="/projects">
                        <i class="fa fa-project-diagram">üìä</i>
                        <span>Qu·∫£n l√Ω d·ª± √°n</span>
                    </a>
                </div>

                <div class="sidebar-section">
                    <p class="section-label">C√îNG C·ª§ H·ªñ TR·ª¢</p>
                    <a class="sidebar-link <%= currentPath.startsWith('/schedule') ? 'active' : '' %>" href="/schedule">
                        <i class="fa fa-calendar-alt">üìÖ</i>
                        <span>L·ªãch c√¥ng t√°c</span>
                    </a>
                    <a class="sidebar-link <%= currentPath.startsWith('/reminders') ? 'active' : '' %>" href="/reminders">
                        <i class="fa fa-bell">üîî</i>
                        <span>Nh·∫Øc vi·ªác</span>
                    </a>
                    <a class="sidebar-link <%= currentPath.startsWith('/reports') ? 'active' : '' %>" href="/reports">
                        <i class="fa fa-chart-bar">üìà</i>
                        <span>B√°o c√°o t·ªïng h·ª£p</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div>Phi√™n b·∫£n</div>
                <div class="badge">v2.1.0</div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="app-main">
            <!-- Top Navigation Bar -->
            <header class="app-topbar">
                <div class="topbar-start">
                    <button class="btn-sidebar-toggle">
                        <i class="fa fa-bars">‚ò∞</i>
                    </button>
                    <div class="topbar-breadcrumb">
                        <span class="breadcrumb-item">Trang ch·ªß</span>
                        <span class="breadcrumb-separator">/</span>
                        <span class="breadcrumb-item active">Dashboard</span>
                    </div>
                </div>
                <div class="topbar-end">
                    <div class="topbar-date">
                        üìÖ <%= new Date().toLocaleDateString('vi-VN', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' }) %>
                    </div>
                    <div class="topbar-user" data-user-menu>
                        <button class="topbar-user__details" type="button" data-user-menu-toggle aria-haspopup="true" aria-expanded="false">
                            <div class="topbar-user__avatar"><%= (user && (user.fullName || user.full_name || user.username) || '?').charAt(0).toUpperCase() %></div>
                            <div class="topbar-user__meta">
                                <div class="topbar-user__name"><%= (user && (user.fullName || user.full_name || user.username)) || 'Admin' %></div>
                                <div class="topbar-user__role"><%= (user && (user.role_label || user.roleName || user.role_name)) || 'Qu·∫£n tr·ªã vi√™n' %></div>
                            </div>
                            <span class="topbar-user__chevron" aria-hidden="true">‚åÑ</span>
                        </button>
                        <div class="topbar-user__menu" data-user-menu-dropdown hidden>
                            <% if (isAdminView) { %>
                            <a class="topbar-user__menu-item" href="/users">
                                <span>üõ°Ô∏è Qu·∫£n l√Ω ng∆∞·ªùi d√πng</span>
                            </a>
                            <% } %>
                            <a class="topbar-user__menu-item" href="<%= (user && user.id) ? ('/users/' + user.id) : '#' %>">
                                <span>üë§ H·ªì s∆° c√° nh√¢n</span>
                            </a>
                            <a class="topbar-user__menu-item" href="/auth/change-password">
                                <span>üîë ƒê·ªïi m·∫≠t kh·∫©u</span>
                            </a>
                            <form class="topbar-user__menu-item" method="post" action="/auth/logout">
                                <button type="submit" class="topbar-user__logout">
                                    <span>üö™ ƒêƒÉng xu·∫•t</span>
                                </button>
                            </form>
                        </div>
                    </div>
                    <form class="topbar-logout" method="post" action="/auth/logout">
                        <button type="submit" class="topbar-logout__button" title="ƒêƒÉng xu·∫•t">
                            <span>ƒêƒÉng xu·∫•t</span>
                            <i aria-hidden="true">‚á¶</i>
                        </button>
                    </form>
                </div>
            </header>

            <!-- Content Area -->
            <main class="app-content">
                <%- include('../partials/alerts') %>
                
                <% 
                const notificationItems = [
                    ...((notifications && notifications.pendingWorkbooks) || []),
                    ...((notifications && notifications.upcomingDeadlines) || []),
                    ...((notifications && notifications.overdueDocuments) || [])
                ].slice(0, 4);
                const documentItems = (recentDocuments || []).slice(0, 4);
                %>

                <div class="dashboard-shell">
                    <header class="dashboard-shell__header">
                        <div class="dashboard-heading">
                            <h1>Trang ch·ªß</h1>
                            <p>Ch√†o m·ª´ng quay tr·ªü l·∫°i, <%= (user && (user.fullName || user.full_name || user.username)) || 'Administrator' %></p>
                            <% if (activeScope) { %>
                                <p class="dashboard-scope__label">
                                    Th·ªëng k√™: <strong><%= activeScope.label %></strong>
                                    <% if (scopeRangeLabel) { %>
                                        ¬∑ <span><%= scopeRangeLabel %></span>
                                    <% } %>
                                </p>
                            <% } %>
                        </div>
                        <div class="dashboard-header-actions">
                            <% if (Array.isArray(scopeOptions) && scopeOptions.length) { %>
                                <form class="scope-switcher" method="get" action="/dashboard">
                                    <label for="dashboard-scope-select">Kho·∫£ng th·ªëng k√™</label>
                                    <select id="dashboard-scope-select" name="scope" data-scope-select>
                                        <% scopeOptions.forEach(function(group){ %>
                                            <optgroup label="<%= group.label %>">
                                                <% group.options.forEach(function(option){ %>
                                                    <option value="<%= option.value %>" <%= (scopeSelectionValue === option.value) ? 'selected' : '' %>>
                                                        <%= option.label %>
                                                    </option>
                                                <% }) %>
                                            </optgroup>
                                        <% }) %>
                                    </select>
                                </form>
                            <% } %>
                            <span class="status-chip status-chip--offline">Ngo·∫°i tuy·∫øn</span>
                        </div>
                    </header>

                    <section class="dashboard-summary">
                        <% summaryCards.forEach(function(card){ %>
                            <article class="summary-card summary-card--<%= card.color %>">
                                <span class="summary-card__marker"></span>
                                <div class="summary-card__value"><%= card.value || 0 %></div>
                                <div class="summary-card__title"><%= card.title %></div>
                                <div class="summary-card__desc"><%= card.subtitle %></div>
                            </article>
                        <% }) %>
                    </section>

                    <section class="dashboard-grid">
                        <div class="dashboard-grid__primary">
                            <article class="panel panel--operations">
                                <header class="panel__header">
                                    <div>
                                        <h2>ƒêi·ªÅu h√†nh nhanh</h2>
                                        <p>Truy c·∫≠p t·ª©c th√¨ v√†o c√°c ph√¢n h·ªá ch√≠nh</p>
                                    </div>
                                </header>
                                <div class="quick-actions">
                                    <% quickActions.forEach(function(action){ %>
                                        <a class="quick-actions__item quick-actions__item--<%= action.color %>" href="<%= action.href %>">
                                            <span><%= action.label %></span>
                                        </a>
                                    <% }) %>
                                </div>
                                <section class="progress-board">
                                    <header>
                                        <h3>Ti·∫øn ƒë·ªô x·ª≠ l√Ω</h3>
                                        <span>
                                            <% if (activeScope) { %>
                                                <%= activeScope.label %>
                                                <% if (scopeRangeLabel) { %>
                                                    ¬∑ <%= scopeRangeLabel %>
                                                <% } %>
                                            <% } else { %>
                                                C·∫≠p nh·∫≠t theo s·ªë li·ªáu m·ªõi nh·∫•t
                                            <% } %>
                                        </span>
                                    </header>
                                    <div class="progress-board__list">
                                        <% progressOverview.forEach(function(metric){ %>
                                            <div class="progress-pill">
                                                <div class="progress-pill__header">
                                                    <span><%= metric.title %></span>
                                                    <strong><%= metric.value %></strong>
                                                </div>
                                                <div class="progress-pill__bar">
                                                    <span class="progress-pill__fill progress-pill__fill--<%= metric.color %>" style="--progress-fill:<%= metric.percent %>;"></span>
                                                </div>
                                            </div>
                                        <% }) %>
                                    </div>
                                </section>
                            </article>

                            <article class="panel panel--activity">
                                <header class="panel__header">
                                    <div>
                                        <h2>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h2>
                                        <span>Nh·∫≠t k√Ω thao t√°c m·ªõi nh·∫•t</span>
                                    </div>
                                </header>
                                <div class="timeline">
                                    <% if (recentActivities && recentActivities.length) { %>
                                        <% recentActivities.forEach(function(activity){ %>
                                            <div class="timeline__item">
                                                <div class="timeline__dot"></div>
                                                <div class="timeline__content">
                                                    <h4><%= activity.title %></h4>
                                                    <p><%= activity.description %></p>
                                                    <% if (activity.time) { %>
                                                        <span class="timeline__time"><%= activity.time %></span>
                                                    <% } %>
                                                </div>
                                            </div>
                                        <% }) %>
                                    <% } else { %>
                                        <p class="placeholder-text">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o g·∫ßn ƒë√¢y.</p>
                                    <% } %>
                                </div>
                            </article>

                            <article class="panel panel--documents">
                                <header class="panel__header">
                                    <div>
                                        <h2>T√†i li·ªáu ƒëang x·ª≠ l√Ω</h2>
                                        <span>Danh s√°ch g√°n cho b·∫°n ho·∫∑c ƒë∆°n v·ªã</span>
                                    </div>
                                </header>
                                <div class="document-stack">
                                    <% if (documentItems.length) { %>
                                        <% documentItems.forEach(function(doc){ %>
                                            <div class="document-card">
                                                <div class="document-card__marker"></div>
                                                <div class="document-card__body">
                                                    <h4><%= doc.title || doc.document_number || 'T√†i li·ªáu' %></h4>
                                                    <% if (doc.processing_deadline) { %>
                                                        <span class="document-card__meta">H·∫°n x·ª≠ l√Ω: <%= doc.processing_deadline %></span>
                                                    <% } %>
                                                </div>
                                            </div>
                                        <% }) %>
                                    <% } else { %>
                                        <p class="placeholder-text">Kh√¥ng c√≥ t√†i li·ªáu n√†o ƒëang ƒë∆∞·ª£c giao.</p>
                                    <% } %>
                                </div>
                            </article>
                        </div>

                        <div class="dashboard-grid__secondary">
                            <article class="panel panel--notifications">
                                <header class="panel__header">
                                    <div>
                                        <h2>Th√¥ng b√°o n·ªôi b·ªô</h2>
                                        <span>T·ª± ƒë·ªông t·ªïng h·ª£p h·∫°n x·ª≠ l√Ω v√† c√¥ng vi·ªác</span>
                                    </div>
                                </header>
                                <div class="notification-list">
                                    <% if (notificationItems.length) { %>
                                        <% notificationItems.forEach(function(item){ %>
                                            <div class="notification-card">
                                                <div class="notification-card__badge <%= item.badgeColor || (item.status === 'overdue' ? 'is-danger' : '') %>">
                                                    <% if (item.badge) { %>
                                                        <span><%= item.badge %></span>
                                                    <% } %>
                                                </div>
                                                <div class="notification-card__body">
                                                    <h4><%= item.title || item.document_number || 'Th√¥ng b√°o' %></h4>
                                                    <p><%= item.content_summary || 'T√†i li·ªáu s·∫Øp ƒë·∫øn h·∫°n x·ª≠ l√Ω, vui l√≤ng ki·ªÉm tra.' %></p>
                                                    <% if (item.processing_deadline) { %>
                                                        <span class="notification-card__meta">H·∫°n: <%= item.processing_deadline %></span>
                                                    <% } %>
                                                    <% if (item.approval_requested_at && item.type === 'workbook') { %>
                                                        <span class="notification-card__meta">G·ª≠i duy·ªát: <%= item.approval_requested_at %></span>
                                                    <% } %>
                                                    <% if (item.link) { %>
                                                        <a class="notification-card__link" href="<%= item.link %>">Xem chi ti·∫øt</a>
                                                    <% } %>
                                                </div>
                                            </div>
                                        <% }) %>
                                    <% } else { %>
                                        <p class="placeholder-text">Ch∆∞a c√≥ th√¥ng b√°o m·ªõi.</p>
                                    <% } %>
                                </div>
                            </article>

                            <article class="panel panel--schedule">
                                <header class="panel__header">
                                    <div>
                                        <h2>L·ªãch tu·∫ßn (c√° nh√¢n)</h2>
                                        <span>L·ªãch h·ªçp v√† c√¥ng t√°c s·∫Øp t·ªõi</span>
                                    </div>
                                </header>
                                <div class="schedule-board">
                                    <% if (scheduleEvents && scheduleEvents.length) { %>
                                        <% scheduleEvents.forEach(function(event){ %>
                                            <div class="schedule-board__item">
                                                <strong><%= event.title %></strong>
                                                <% if (event.timeRange) { %>
                                                    <span><%= event.timeRange %></span>
                                                <% } %>
                                                <% if (event.location) { %>
                                                    <span><%= event.location %></span>
                                                <% } %>
                                            </div>
                                        <% }) %>
                                    <% } else { %>
                                        <p class="placeholder-text">Kh√¥ng c√≥ l·ªãch c√¥ng t√°c n√†o trong tu·∫ßn.</p>
                                    <% } %>
                                </div>
                            </article>

                            <article class="panel panel--reminders">
                                <header class="panel__header">
                                    <div>
                                        <h2>Nh·∫Øc vi·ªác</h2>
                                        <span>S·∫Øp x·∫øp theo m·ª©c ∆∞u ti√™n</span>
                                    </div>
                                </header>
                                <div class="reminder-grid" data-reminder-grid>
                                    <% if (reminders && reminders.length) { %>
                                        <% reminders.forEach(function(reminder){ %>
                                            <div class="reminder-pill" data-reminder-id="<%= reminder.id %>">
                                                <div class="reminder-pill__header">
                                                    <span class="reminder-pill__badge reminder-pill__badge--<%= reminder.badgeColor %>"><%= reminder.badge %></span>
                                                    <span class="reminder-pill__priority">∆Øu ti√™n: <strong><%= reminder.priority %></strong></span>
                                                </div>
                                                <h4><%= reminder.title %></h4>
                                                <p><%= reminder.description %></p>
                                                <div class="reminder-pill__meta">
                                                    <% if (reminder.deadlineLabel) { %>
                                                        <span class="reminder-pill__deadline">H·∫°n: <%= reminder.deadlineLabel %></span>
                                                    <% } %>
                                                    <% if (reminder.relativeLabel) { %>
                                                        <span class="reminder-pill__relative <%= reminder.isOverdue ? 'is-overdue' : '' %>"><%= reminder.relativeLabel %></span>
                                                    <% } %>
                                                </div>
                                                <% if (reminder.canComplete) { %>
                                                    <button 
                                                        class="reminder-pill__action" 
                                                        data-action="complete" 
                                                        data-document-id="<%= reminder.id %>">
                                                        Ho√†n th√†nh
                                                    </button>
                                                <% } else if (reminder.status === 'completed') { %>
                                                    <span class="reminder-pill__status">ƒê√£ ho√†n th√†nh</span>
                                                <% } %>
                                            </div>
                                        <% }) %>
                                    <% } else { %>
                                        <p class="placeholder-text">Kh√¥ng c√≥ nh·∫Øc vi·ªác n√†o.</p>
                                    <% } %>
                                </div>
                            </article>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <!-- Custom JS -->
    <script src="/assets/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const reminderGrid = document.querySelector('[data-reminder-grid]');
            if (reminderGrid) {
                    reminderGrid.addEventListener('click', async function (event) {
                        const actionButton = event.target.closest('[data-action="complete"]');
                        if (!actionButton) {
                            return;
                        }

                        event.preventDefault();
                        if (actionButton.disabled) {
                            return;
                        }

                        const documentId = actionButton.getAttribute('data-document-id');
                        if (!documentId) {
                            return;
                        }

                        const originalLabel = actionButton.textContent;
                        actionButton.disabled = true;
                        actionButton.textContent = 'ƒêang x·ª≠ l√Ω‚Ä¶';

                        try {
                            const response = await fetch(`/dashboard/reminders/${documentId}/complete`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                credentials: 'same-origin'
                            });

                            if (response.status === 401) {
                                window.location.href = '/auth/login';
                                return;
                            }

                            const payload = await response.json();
                            if (!response.ok || !payload.success) {
                                throw new Error(payload.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i nh·∫Øc vi·ªác');
                            }

                            actionButton.textContent = 'ƒêang c·∫≠p nh·∫≠t‚Ä¶';
                            const reminderItem = actionButton.closest('.reminder-pill');
                            if (reminderItem) {
                                reminderItem.classList.add('reminder-pill--completed');
                                const badge = reminderItem.querySelector('.reminder-pill__badge');
                                if (badge) {
                                    badge.textContent = 'ƒê√£ ho√†n th√†nh';
                                    badge.classList.remove('reminder-pill__badge--warning', 'reminder-pill__badge--danger');
                                    badge.classList.add('reminder-pill__badge--success');
                                }
                                const relative = reminderItem.querySelector('.reminder-pill__relative');
                                if (relative) {
                                    relative.textContent = 'ƒê√£ ho√†n t·∫•t';
                                    relative.classList.remove('is-overdue');
                                }

                                window.setTimeout(() => {
                                    reminderItem.remove();
                                    const remainingItems = reminderGrid.querySelectorAll('.reminder-pill');
                                    if (!remainingItems.length) {
                                        const placeholder = document.createElement('p');
                                        placeholder.className = 'placeholder-text';
                                        placeholder.textContent = 'Kh√¥ng c√≥ nh·∫Øc vi·ªác n√†o.';
                                        reminderGrid.appendChild(placeholder);
                                    }
                                }, 200);
                            }
                        } catch (error) {
                            console.error(error);
                            actionButton.disabled = false;
                            actionButton.textContent = originalLabel;
                            window.alert(error.message || 'Kh√¥ng th·ªÉ ho√†n t·∫•t nh·∫Øc vi·ªác. Vui l√≤ng th·ª≠ l·∫°i.');
                        }
                    });
                }

                const scopeSelect = document.querySelector('[data-scope-select]');
                if (scopeSelect && scopeSelect.form) {
                    scopeSelect.addEventListener('change', () => {
                        scopeSelect.form.submit();
                    });
                }
        });
    </script>
</body>
</html>