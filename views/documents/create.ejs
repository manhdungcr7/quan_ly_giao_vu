<%- contentFor('css') %>
<link rel="stylesheet" href="/css/documents.css">

<%- contentFor('content') %>
<%- include('../partials/alerts') %>
<div class="documents-page">
  <div class="page-header">
    <div>
      <h1 class="page-title">Thêm văn bản mới</h1>
      <p class="page-subtitle">Tạo văn bản đến hoặc văn bản đi trong hệ thống</p>
    </div>
    <div class="page-actions">
      <a href="/documents" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Quay lại</a>
    </div>
  </div>

  <% if (typeof error !== 'undefined' && error.length > 0) { %>
    <div class="alert alert-danger">
      <%= error %>
    </div>
  <% } %>

  <% const usersList = Array.isArray(users) ? users : []; %>
  <% const organizationsList = Array.isArray(organizations) ? organizations : []; %>
  <% const typesList = Array.isArray(types) ? types : []; %>
  <% const assignedSelected = usersList.find(function(u){ return String(u.id) === String(formData && formData.assigned_to || ''); }); %>
  <% const toOrgSelected = organizationsList.find(function(o){ return String(o.id) === String(formData && formData.to_org_id || ''); }); %>
  <% const fromOrgSelected = organizationsList.find(function(o){ return String(o.id) === String(formData && formData.from_org_id || ''); }); %>
  <% const typeSelected = typesList.find(function(t){ return String(t.id) === String(formData && formData.type_id || ''); }); %>
  
  <% const STATUS_LABELS = {
    pending: 'Chờ xử lý',
    processing: 'Đang xử lý',
    completed: 'Hoàn tất',
    approved: 'Đã duyệt',
    archived: 'Đã lưu trữ'
  }; %>

  <form method="post" action="/documents" class="document-form" enctype="multipart/form-data">
    <div class="form-grid">
      <div class="form-section">
        <h3>Thông tin cơ bản</h3>
        
        <div class="form-group">
          <label for="direction" class="required">Loại văn bản</label>
          <select name="direction" id="direction" required>
            <option value="">-- Chọn loại --</option>
            <option value="incoming" <%= (formData?.direction === 'incoming') ? 'selected' : '' %>>Văn bản đến</option>
            <option value="outgoing" <%= (formData?.direction === 'outgoing') ? 'selected' : '' %>>Văn bản đi</option>
          </select>
        </div>

        <div class="form-group">
          <label for="document_number" class="required">Số hiệu văn bản</label>
          <input type="text" name="document_number" id="document_number" 
                 value="<%= formData?.document_number || '' %>" 
                 placeholder="VD: 123/QD-ĐHBK" required>
          <small>Số hiệu phải duy nhất trong hệ thống</small>
        </div>

        <div class="form-group">
          <label for="title" class="required">Tiêu đề</label>
          <input type="text" name="title" id="title" 
                 value="<%= formData?.title || '' %>" 
                 placeholder="Nhập tiêu đề văn bản" required>
        </div>

        <div class="form-group">
          <label for="type_id">Loại văn bản</label>
          <input type="hidden" name="type_id" id="type_id" value="<%= formData?.type_id || '' %>">
          <input type="text" id="type_id_display" list="typeIdOptions"
                 placeholder="Gõ để tìm loại văn bản"
                 value="<%= typeSelected ? typeSelected.name : '' %>"
                 autocomplete="off">
          <datalist id="typeIdOptions">
            <% typesList.forEach(function(type) { %>
              <option value="<%= type.name %>" data-id="<%= type.id %>"></option>
            <% }) %>
          </datalist>
          <small>Tìm kiếm nhanh bằng cách nhập tên loại văn bản.</small>
        </div>

        <div class="form-group">
          <label for="content_summary">Trích yếu nội dung</label>
          <textarea name="content_summary" id="content_summary" rows="3" 
                    placeholder="Tóm tắt nội dung văn bản"><%= formData?.content_summary || '' %></textarea>
        </div>

        <div class="form-group">
          <label for="chi_dao">Chỉ đạo / Đề xuất tham mưu</label>
          <textarea name="chi_dao" id="chi_dao" rows="3" placeholder="Nhập ý kiến đề xuất hoặc chỉ đạo ban đầu"><%= formData?.chi_dao || '' %></textarea>
          <small>Phần này dùng để ghi chú chỉ đạo sơ bộ hoặc đề xuất tham mưu gửi lãnh đạo.</small>
        </div>
      </div>

      <div class="form-section">
        <h3>Thông tin xử lý</h3>

        <div class="form-group">
          <label for="issue_date">Ngày ban hành</label>
          <input type="date" name="issue_date" id="issue_date" 
                 value="<%= formData?.issue_date || '' %>">
        </div>

        <div class="form-group">
          <label for="received_date">Ngày nhận</label>
          <input type="date" name="received_date" id="received_date" 
                 value="<%= formData?.received_date || '' %>">
        </div>

        <div class="form-group">
          <label for="processing_deadline">Hạn xử lý</label>
          <input type="date" name="processing_deadline" id="processing_deadline" 
                 value="<%= formData?.processing_deadline || '' %>">
        </div>

        <div class="form-group">
          <label for="priority">Độ ưu tiên</label>
          <input type="hidden" name="priority" id="priority" value="<%= formData?.priority || 'medium' %>">
          <input type="text" id="priority_display" list="priorityOptions"
                 placeholder="Chọn độ ưu tiên"
                 value="<%= formData?.priority === 'low' ? 'Thấp' : formData?.priority === 'high' ? 'Cao' : formData?.priority === 'urgent' ? 'Khẩn cấp' : 'Bình thường' %>"
                 autocomplete="off">
          <datalist id="priorityOptions">
            <option value="Thấp" data-id="low"></option>
            <option value="Bình thường" data-id="medium"></option>
            <option value="Cao" data-id="high"></option>
            <option value="Khẩn cấp" data-id="urgent"></option>
          </datalist>
          <small>Nhập để chọn mức độ ưu tiên xử lý văn bản.</small>
        </div>
        
        <div class="form-group">
          <label for="status">Trạng thái</label>
          <input type="hidden" name="status" id="status" value="<%= formData?.status || 'pending' %>">
          <input type="text" id="status_display" list="statusOptions"
                 placeholder="Chọn trạng thái"
                 value="<%= STATUS_LABELS[formData?.status] || 'Chờ xử lý' %>"
                 autocomplete="off">
          <datalist id="statusOptions">
            <option value="Chờ xử lý" data-id="pending"></option>
            <option value="Đang xử lý" data-id="processing"></option>
            <option value="Hoàn tất" data-id="completed"></option>
            <option value="Đã duyệt" data-id="approved"></option>
            <option value="Đã lưu trữ" data-id="archived"></option>
          </datalist>
          <small>Trạng thái hiện tại của văn bản trong quy trình xử lý.</small>
        </div>

        <div class="form-group">
          <label for="assigned_to_display">Người xử lý</label>
          <input type="hidden" name="assigned_to" id="assigned_to" value="<%= formData?.assigned_to || '' %>">
          <input type="text" id="assigned_to_display" list="assignedToOptions"
                 placeholder="Gõ để tìm nhanh người xử lý"
                 value="<%= assignedSelected ? assignedSelected.full_name : '' %>"
                 autocomplete="off">
          <datalist id="assignedToOptions">
            <% usersList.forEach(function(user) { %>
              <option value="<%= user.full_name %>" data-id="<%= user.id %>"></option>
            <% }) %>
          </datalist>
          <small>Nhập vài ký tự để lọc nhanh danh sách nhân sự.</small>
        </div>
      </div>

      <div class="form-section">
        <h3>Cơ quan liên quan</h3>

        <div class="form-group" id="from_org_group">
          <label for="from_org_id">Cơ quan gửi</label>
          <input type="hidden" name="from_org_id" id="from_org_id" value="<%= formData?.from_org_id || '' %>">
          <input type="text" id="from_org_display" list="fromOrgOptions"
                 placeholder="Gõ để tìm cơ quan gửi"
                 value="<%= fromOrgSelected ? fromOrgSelected.name : '' %>"
                 autocomplete="off">
          <datalist id="fromOrgOptions">
            <% organizationsList.forEach(function(org) { %>
              <option value="<%= org.name %>" data-id="<%= org.id %>"></option>
            <% }) %>
          </datalist>
          <small>Tìm kiếm nhanh bằng cách nhập tên cơ quan.</small>
        </div>

        <div class="form-group" id="to_org_group">
          <label for="to_org_display">Cơ quan nhận</label>
          <input type="hidden" name="to_org_id" id="to_org_id" value="<%= formData?.to_org_id || '' %>">
          <input type="text" id="to_org_display" list="toOrgOptions"
                 placeholder="Gõ để tìm cơ quan nhận"
                 value="<%= toOrgSelected ? toOrgSelected.name : '' %>"
                 autocomplete="off">
          <datalist id="toOrgOptions">
            <% organizationsList.forEach(function(org) { %>
              <option value="<%= org.name %>" data-id="<%= org.id %>"></option>
            <% }) %>
          </datalist>
          <small>Tìm kiếm nhanh bằng cách nhập tên cơ quan.</small>
        </div>

        <div class="form-group">
          <label for="attachments">File đính kèm</label>
          <input type="file" name="attachments" id="attachments" multiple 
                 accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.jpg,.png">
          <small>Chấp nhận: PDF, Word, Excel, ảnh. Tối đa 10MB mỗi file.</small>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save"></i> Lưu văn bản
      </button>
      <a href="/documents" class="btn btn-secondary">
        <i class="fas fa-times"></i> Hủy bỏ
      </a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  function bindDatalist(inputId, hiddenId, datalistId) {
    var input = document.getElementById(inputId);
    var hidden = document.getElementById(hiddenId);
    var datalist = document.getElementById(datalistId);
    if (!input || !hidden || !datalist) {
      return;
    }

    function syncHidden() {
      var value = input.value.trim();
      var matchedOption = null;
      for (var i = 0; i < datalist.options.length; i++) {
        if (datalist.options[i].value === value) {
          matchedOption = datalist.options[i];
          break;
        }
      }

      if (matchedOption) {
        hidden.value = matchedOption.dataset.id || matchedOption.value;
      } else {
        hidden.value = '';
      }
    }

    input.addEventListener('change', syncHidden);
    input.addEventListener('blur', syncHidden);
    input.addEventListener('input', function() {
      if (!input.value.trim()) {
        hidden.value = '';
      }
    });

    syncHidden();
  }

  // Bind all datalist fields
  bindDatalist('type_id_display', 'type_id', 'typeIdOptions');
  bindDatalist('priority_display', 'priority', 'priorityOptions');
  bindDatalist('status_display', 'status', 'statusOptions');
  bindDatalist('assigned_to_display', 'assigned_to', 'assignedToOptions');
  bindDatalist('from_org_display', 'from_org_id', 'fromOrgOptions');
  bindDatalist('to_org_display', 'to_org_id', 'toOrgOptions');

  var directionEl = document.getElementById('direction');
  var fromOrgGroup = document.getElementById('from_org_group');
  var toOrgGroup = document.getElementById('to_org_group');
  var fromOrgInput = document.getElementById('from_org_display');
  var toOrgInput = document.getElementById('to_org_display');

  function toggleOrgFields() {
    if (!directionEl) {
      return;
    }

    var direction = directionEl.value;

    if (direction === 'incoming') {
      if (fromOrgGroup) fromOrgGroup.style.display = 'block';
      if (toOrgGroup) toOrgGroup.style.display = 'none';
      if (fromOrgInput) fromOrgInput.required = true;
      if (toOrgInput) {
        toOrgInput.required = false;
        toOrgInput.value = '';
      }
      var toOrgHidden = document.getElementById('to_org_id');
      if (toOrgHidden) {
        toOrgHidden.value = '';
      }
    } else if (direction === 'outgoing') {
      if (fromOrgGroup) fromOrgGroup.style.display = 'none';
      if (toOrgGroup) toOrgGroup.style.display = 'block';
      if (fromOrgInput) {
        fromOrgInput.required = false;
        fromOrgInput.value = '';
      }
      var fromOrgHidden = document.getElementById('from_org_id');
      if (fromOrgHidden) {
        fromOrgHidden.value = '';
      }
      if (toOrgInput) toOrgInput.required = true;
    } else {
      if (fromOrgGroup) fromOrgGroup.style.display = 'block';
      if (toOrgGroup) toOrgGroup.style.display = 'block';
      if (fromOrgInput) fromOrgInput.required = false;
      if (toOrgInput) toOrgInput.required = false;
    }
  }

  if (directionEl) {
    directionEl.addEventListener('change', toggleOrgFields);
    toggleOrgFields();
  }
});
</script>