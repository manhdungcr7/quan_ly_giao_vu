<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title ? title + ' - ' : '' %><%= appName %></title>
    <% const appUrlObject = (() => { try { return new URL(appUrl); } catch (_) { return null; } })(); %>
    <% const canonicalHost = appUrlObject ? appUrlObject.host : 'localhost:3000'; %>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" type="image/png" sizes="32x32" href="/favicon-32.png">
    <script>
        (function(){
            function enforceDevScheme(){
                var body = document.body;
                if (!body) {
                    return;
                }

                var dataset = body.dataset || {};
                var supportsHttps = dataset.supportsHttps === '1';
                if (supportsHttps) {
                    return;
                }

                var protocol = window.location.protocol;
                var host = window.location.hostname;
                var portValue = window.location.port;
                var port = portValue ? ':' + portValue : '';
                var isLoopback = (host === 'localhost' || host === '127.0.0.1');
                var isPrivateIPv4 = /^10\.|^192\.168\.|^172\.(1[6-9]|2\d|3[0-1])\./.test(host);
                var portNumber = portValue ? parseInt(portValue, 10) : null;
                var isDevPort = portNumber === null || (portNumber >= 3000 && portNumber <= 3999);
                var shouldDowngrade = protocol === 'https:' && (isLoopback || isPrivateIPv4) && isDevPort;

                if (shouldDowngrade) {
                    var fallbackUrl = dataset.httpFallback || '';
                    var targetHost = isLoopback ? '127.0.0.1' : host;
                    var base = fallbackUrl && fallbackUrl.startsWith('http') ? fallbackUrl : ('http://' + targetHost + port);
                    var target = base + window.location.pathname + window.location.search + window.location.hash;
                    if (target !== window.location.href) {
                        window.location.replace(target);
                    }
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', enforceDevScheme);
            } else {
                enforceDevScheme();
            }
        })();
    </script>
    
    <!-- Custom CSS -->
    <link href="/css/app.css" rel="stylesheet">
    <link href="/assets/css/style.css" rel="stylesheet">
    <link href="/css/layout.css" rel="stylesheet">
    <link href="/css/breadcrumb.css" rel="stylesheet">
    <!-- Font Awesome for file type icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-Avb2QiuDEEvB4bZJYdft2mNjVShBftLdPG8FJ0V7irTLQ8Uo0qcPxh4Plq7G5tGm0rU+1SPhVotteLpBERwTkw==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <!-- Additional CSS -->
    <%- defineContent('css') %>
</head>
<body class="<%= isAuthenticated ? 'app-auth' : '' %>" data-supports-https="<%= supportsHttps ? '1' : '0' %>" data-http-fallback="<%= httpFallbackUrl %>">
    <% if (isAuthenticated) { %>
        <div class="app-layout">
            <aside class="app-sidebar" id="appSidebar">
                <div class="sidebar-brand">
                    <span class="sidebar-brand__logo">KA</span>
                    <div class="sidebar-brand__text">
                        <span class="sidebar-brand__title"><%= appName %></span>
                        <small class="sidebar-brand__subtitle">Khoa An ninh ƒëi·ªÅu tra</small>
                    </div>
                </div>
                <%- include('../partials/sidebar') %>
            </aside>
            <div class="app-main">
                <header class="app-topbar">
                    <div class="topbar-brand">
                        <span class="topbar-brand__logo">KA</span>
                        <div class="topbar-brand__text">
                            <span class="topbar-brand__title">Khoa An ninh ƒëi·ªÅu tra</span>
                            <span class="topbar-brand__subtitle">qu·∫£n l√Ω gi√°o v·ª• Khoa</span>
                        </div>
                    </div>
                    <div class="topbar-page">
                        <h1><%= title || 'Trang ch·ªß' %></h1>
                        <p>Xin ch√†o, <%= (user && (user.fullName || user.full_name || user.username)) || 'Ng∆∞·ªùi d√πng' %></p>
                    </div>
                    <div class="topbar-actions">
                        <div class="topbar-date"><%= new Date().toLocaleDateString('vi-VN', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' }) %></div>
                        <div class="topbar-user" data-user-menu>
                            <button class="topbar-user__details" type="button" data-user-menu-toggle aria-haspopup="true" aria-expanded="false">
                                <div class="topbar-user__meta">
                                    <span class="topbar-user__name"><%= (user && (user.fullName || user.full_name || user.username)) || 'Ng∆∞·ªùi d√πng' %></span>
                                    <span class="topbar-user__role"><%= (user && (user.role_label || user.roleName || user.role_name)) || 'Administrator' %></span>
                                </div>
                                <div class="topbar-user__avatar"><%= (user && (user.fullName || user.full_name || user.username) || '?').charAt(0).toUpperCase() %></div>
                                <span class="topbar-user__chevron" aria-hidden="true">‚åÑ</span>
                            </button>
                            <div class="topbar-user__menu" data-user-menu-dropdown hidden>
                                <% const userRoleName = user && (user.role_name || user.roleName); %>
                                <% const isAdminView = userRoleName && userRoleName.toString().toLowerCase() === 'admin'; %>
                                <% if (isAdminView) { %>
                                <a class="topbar-user__menu-item" href="/users">
                                    <span>üõ°Ô∏è Qu·∫£n l√Ω ng∆∞·ªùi d√πng</span>
                                </a>
                                <% } %>
                                <a class="topbar-user__menu-item" href="<%= (user && user.id) ? ('/users/' + user.id) : '#' %>">
                                    <span>üë§ H·ªì s∆° c√° nh√¢n</span>
                                </a>
                                <a class="topbar-user__menu-item" href="/auth/change-password">
                                    <span>üîë ƒê·ªïi m·∫≠t kh·∫©u</span>
                                </a>
                                <form class="topbar-user__menu-item" method="post" action="/auth/logout">
                                    <button type="submit" class="topbar-user__logout">
                                        <span>üö™ ƒêƒÉng xu·∫•t</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                        <form class="topbar-logout" method="post" action="/auth/logout">
                            <button type="submit" class="topbar-logout__button" title="ƒêƒÉng xu·∫•t">
                                <span>ƒêƒÉng xu·∫•t</span>
                                <i aria-hidden="true">‚á¶</i>
                            </button>
                        </form>
                    </div>
                </header>
                <main class="app-content">
                    <%- include('../partials/alerts') %>
                    <%- body %>
                </main>
            </div>
        </div>
    <% } else { %>
        <div class="auth-page">
            <div class="auth-alerts">
                <%- include('../partials/alerts') %>
            </div>
            <%- body %>
        </div>
    <% } %>
    
    <!-- Footer -->
    <%- include('../partials/footer') %>
    
    <!-- Custom JS -->
    <script src="/js/app.js"></script>
    
    <!-- Additional JS -->
    <%- defineContent('js') %>
</body>
</html>