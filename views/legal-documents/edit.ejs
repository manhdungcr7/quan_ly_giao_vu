<%- contentFor('css') %>
<link rel="stylesheet" href="/css/documents.css">

<%- contentFor('content') %>
<div class="documents-page">
  <div class="page-header">
    <div>
      <h1 class="page-title">‚úèÔ∏è Ch·ªânh s·ª≠a vƒÉn b·∫£n ph√°p l√Ω</h1>
      <p class="page-subtitle"><%= document.document_number %> - <%= document.title %></p>
    </div>
    <div class="page-actions">
      <a href="/legal-documents/<%= document.id %>" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Quay l·∫°i</a>
    </div>
  </div>

  <% if (typeof success !== 'undefined' && success.length > 0) { %>
    <div class="alert alert-success">
      <%= success %>
    </div>
  <% } %>

  <% if (typeof error !== 'undefined' && error.length > 0) { %>
    <div class="alert alert-danger">
      <%= error %>
    </div>
  <% } %>

  <form method="post" action="/legal-documents/<%= document.id %>" class="document-form" enctype="multipart/form-data">
    <input type="hidden" name="_method" value="PUT">
    
    <div class="form-grid">
      <!-- C·ªôt tr√°i: Th√¥ng tin c∆° b·∫£n -->
      <div class="form-section">
        <h3>üìã Th√¥ng tin c∆° b·∫£n</h3>
        
        <div class="form-group">
          <label for="document_number" class="required">S·ªë hi·ªáu vƒÉn b·∫£n</label>
          <input type="text" name="document_number" id="document_number" 
                 value="<%= document.document_number %>" 
                 placeholder="VD: QC-QLTL-2025, 12/2025/NQ-HƒêQT" required>
          <small>S·ªë hi·ªáu ph·∫£i duy nh·∫•t trong h·ªá th·ªëng</small>
        </div>

        <div class="form-group">
          <label for="title" class="required">Ti√™u ƒë·ªÅ vƒÉn b·∫£n</label>
          <input type="text" name="title" id="title" 
                 value="<%= document.title %>" 
                 placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ƒë·∫ßy ƒë·ªß" required>
        </div>

        <div class="form-group">
          <label for="document_type" class="required">Lo·∫°i vƒÉn b·∫£n</label>
          <select name="document_type" id="document_type" required>
            <option value="">-- Ch·ªçn lo·∫°i --</option>
            <option value="Lu·∫≠t" <%= document.document_type === 'Lu·∫≠t' ? 'selected' : '' %>>Lu·∫≠t</option>
            <option value="Ngh·ªã ƒë·ªãnh" <%= document.document_type === 'Ngh·ªã ƒë·ªãnh' ? 'selected' : '' %>>Ngh·ªã ƒë·ªãnh</option>
            <option value="Th√¥ng t∆∞" <%= document.document_type === 'Th√¥ng t∆∞' ? 'selected' : '' %>>Th√¥ng t∆∞</option>
            <option value="Quy·∫øt ƒë·ªãnh" <%= document.document_type === 'Quy·∫øt ƒë·ªãnh' ? 'selected' : '' %>>Quy·∫øt ƒë·ªãnh</option>
            <option value="Ngh·ªã quy·∫øt" <%= document.document_type === 'Ngh·ªã quy·∫øt' ? 'selected' : '' %>>Ngh·ªã quy·∫øt</option>
            <option value="Quy ch·∫ø" <%= document.document_type === 'Quy ch·∫ø' ? 'selected' : '' %>>Quy ch·∫ø</option>
            <option value="Quy ƒë·ªãnh" <%= document.document_type === 'Quy ƒë·ªãnh' ? 'selected' : '' %>>Quy ƒë·ªãnh</option>
            <option value="H∆∞·ªõng d·∫´n" <%= document.document_type === 'H∆∞·ªõng d·∫´n' ? 'selected' : '' %>>H∆∞·ªõng d·∫´n</option>
            <option value="C√¥ng vƒÉn" <%= document.document_type === 'C√¥ng vƒÉn' ? 'selected' : '' %>>C√¥ng vƒÉn</option>
            <option value="Kh√°c" <%= document.document_type === 'Kh√°c' ? 'selected' : '' %>>Kh√°c</option>
          </select>
        </div>

        <div class="form-group">
          <label for="issuing_authority" class="required">C∆° quan ban h√†nh</label>
          <input type="text" name="issuing_authority" id="issuing_authority" 
                 value="<%= document.issuing_authority || '' %>" 
                 placeholder="VD: B·ªô Gi√°o d·ª•c v√† ƒê√†o t·∫°o, HƒêQT Tr∆∞·ªùng" required>
        </div>

        <div class="form-group">
          <label for="subject">Lƒ©nh v·ª±c</label>
          <input type="text" name="subject" id="subject" 
                 value="<%= document.subject || '' %>" 
                 placeholder="VD: Qu·∫£n l√Ω gi√°o d·ª•c, T√†i ch√≠nh, Nh√¢n s·ª±">
        </div>

        <div class="form-group">
          <label for="summary">T√≥m t·∫Øt n·ªôi dung</label>
          <textarea name="summary" id="summary" rows="4" 
                    placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn n·ªôi dung ch√≠nh c·ªßa vƒÉn b·∫£n"><%= document.summary || '' %></textarea>
        </div>

        <div class="form-group">
          <label for="keywords">T·ª´ kh√≥a</label>
          <input type="text" name="keywords" id="keywords" 
                 value="<%= document.keywords || '' %>" 
                 placeholder="VD: h·ªçc ph√≠, tuy·ªÉn sinh, khen th∆∞·ªüng">
          <small>Ph√¢n c√°ch b·ªüi d·∫•u ph·∫©y</small>
        </div>
      </div>

      <!-- C·ªôt ph·∫£i: Th√¥ng tin ph√°p l√Ω -->
      <div class="form-section">
        <h3>‚öñÔ∏è Th√¥ng tin ph√°p l√Ω</h3>

        <div class="form-group">
          <label for="issue_date" class="required">Ng√†y ban h√†nh</label>
          <input type="date" name="issue_date" id="issue_date" 
                 value="<%= document.issue_date ? new Date(document.issue_date).toISOString().split('T')[0] : '' %>" 
                 required>
        </div>

        <div class="form-group">
          <label for="effective_date">Ng√†y c√≥ hi·ªáu l·ª±c</label>
          <input type="date" name="effective_date" id="effective_date" 
                 value="<%= document.effective_date ? new Date(document.effective_date).toISOString().split('T')[0] : '' %>">
          <small>ƒê·ªÉ tr·ªëng n·∫øu c√≥ hi·ªáu l·ª±c ngay t·ª´ ng√†y ban h√†nh</small>
        </div>

        <div class="form-group">
          <label for="expiry_date">Ng√†y h·∫øt hi·ªáu l·ª±c</label>
          <input type="date" name="expiry_date" id="expiry_date" 
                 value="<%= document.expiry_date ? new Date(document.expiry_date).toISOString().split('T')[0] : '' %>">
          <small>ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng x√°c ƒë·ªãnh</small>
        </div>

        <div class="form-group">
          <label for="status" class="required">Tr·∫°ng th√°i</label>
          <select name="status" id="status" required>
            <option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
            <option value="D·ª± th·∫£o" <%= document.status === 'D·ª± th·∫£o' ? 'selected' : '' %>>üìù D·ª± th·∫£o</option>
            <option value="C√≤n hi·ªáu l·ª±c" <%= document.status === 'C√≤n hi·ªáu l·ª±c' ? 'selected' : '' %>>‚úÖ C√≤n hi·ªáu l·ª±c</option>
            <option value="H·∫øt hi·ªáu l·ª±c" <%= document.status === 'H·∫øt hi·ªáu l·ª±c' ? 'selected' : '' %>>‚è≥ H·∫øt hi·ªáu l·ª±c</option>
            <option value="B·ªã thay th·∫ø" <%= document.status === 'B·ªã thay th·∫ø' ? 'selected' : '' %>>üîÑ B·ªã thay th·∫ø</option>
            <option value="ƒê√£ h·ªßy" <%= document.status === 'ƒê√£ h·ªßy' ? 'selected' : '' %>>‚ùå ƒê√£ h·ªßy</option>
          </select>
        </div>

        <div class="form-group">
          <label for="signer_name">Ng∆∞·ªùi k√Ω</label>
          <input type="text" name="signer_name" id="signer_name" 
                 value="<%= document.signer_name || '' %>" 
                 placeholder="H·ªç t√™n ng∆∞·ªùi k√Ω ban h√†nh">
        </div>

        <div class="form-group">
          <label for="signer_position">Ch·ª©c v·ª• ng∆∞·ªùi k√Ω</label>
          <input type="text" name="signer_position" id="signer_position" 
                 value="<%= document.signer_position || '' %>" 
                 placeholder="VD: Hi·ªáu tr∆∞·ªüng, B·ªô tr∆∞·ªüng">
        </div>

        <div class="form-group">
          <label for="replaced_by">VƒÉn b·∫£n thay th·∫ø</label>
          <input type="text" name="replaced_by" id="replaced_by" 
                 value="<%= document.replaced_by || '' %>" 
                 placeholder="S·ªë hi·ªáu vƒÉn b·∫£n thay th·∫ø (n·∫øu c√≥)">
          <small>Ch·ªâ ƒëi·ªÅn khi tr·∫°ng th√°i l√† "B·ªã thay th·∫ø"</small>
        </div>

        <div class="form-group">
          <label for="related_documents">VƒÉn b·∫£n li√™n quan</label>
          <textarea name="related_documents" id="related_documents" rows="3" 
                    placeholder="Li·ªát k√™ c√°c vƒÉn b·∫£n li√™n quan (m·ªói vƒÉn b·∫£n m·ªôt d√≤ng)"><%= document.related_documents || '' %></textarea>
        </div>
      </div>
    </div>

    <!-- Files ƒë√≠nh k√®m hi·ªán t·∫°i -->
    <% if (document.files && document.files.length > 0) { %>
    <div class="form-section full-width">
      <h3>üìé Files ƒë√≠nh k√®m hi·ªán t·∫°i</h3>
      <div class="attachment-list">
        <% document.files.forEach(function(file) { %>
        <div class="attachment-item">
          <div class="file-info">
            <i class="fas fa-file-pdf file-icon"></i>
            <span class="file-name"><%= file.original_name %></span>
            <small>(<%= (file.size / 1024).toFixed(1) %> KB)</small>
          </div>
        </div>
        <% }); %>
      </div>
    </div>
    <% } %>

    <!-- Th√™m files m·ªõi -->
    <div class="form-section full-width">
      <h3>üìé Th√™m files ƒë√≠nh k√®m m·ªõi</h3>
      <div class="form-group">
        <label for="attachments">Ch·ªçn files (t·ªëi ƒëa 5 files)</label>
        <input type="file" name="attachments" id="attachments" multiple 
               accept=".pdf,.doc,.docx,.rar,.zip">
        <small>H·ªó tr·ª£: PDF, Word, RAR, ZIP. M·ªói file t·ªëi ƒëa 10MB</small>
      </div>
      <div id="file-preview" class="file-preview"></div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save"></i> C·∫≠p nh·∫≠t vƒÉn b·∫£n
      </button>
      <a href="/legal-documents/<%= document.id %>" class="btn btn-secondary">
        <i class="fas fa-times"></i> H·ªßy b·ªè
      </a>
    </div>
  </form>
</div>

<script>
// File preview
document.getElementById('attachments').addEventListener('change', function(e) {
  const preview = document.getElementById('file-preview');
  preview.innerHTML = '';
  
  if (this.files.length > 5) {
    alert('Ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa 5 files!');
    this.value = '';
    return;
  }
  
  Array.from(this.files).forEach(file => {
    // Check file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert(`File "${file.name}" v∆∞·ª£t qu√° 10MB!`);
      this.value = '';
      return;
    }
    
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    
    let icon = 'fa-file';
    if (file.type === 'application/pdf') icon = 'fa-file-pdf';
    else if (file.type.includes('word')) icon = 'fa-file-word';
    else if (file.type.includes('zip') || file.type.includes('rar')) icon = 'fa-file-archive';
    
    fileItem.innerHTML = `
      <i class="fas ${icon} file-icon"></i>
      <span class="file-name">${file.name}</span>
      <small>(${(file.size / 1024).toFixed(1)} KB)</small>
    `;
    preview.appendChild(fileItem);
  });
});

// Date validation
const issueDate = document.getElementById('issue_date');
const effectiveDate = document.getElementById('effective_date');
const expiryDate = document.getElementById('expiry_date');

effectiveDate.addEventListener('change', function() {
  if (issueDate.value && this.value) {
    if (new Date(this.value) < new Date(issueDate.value)) {
      alert('Ng√†y c√≥ hi·ªáu l·ª±c kh√¥ng th·ªÉ tr∆∞·ªõc ng√†y ban h√†nh!');
      this.value = '';
    }
  }
});

expiryDate.addEventListener('change', function() {
  const compareDate = effectiveDate.value || issueDate.value;
  if (compareDate && this.value) {
    if (new Date(this.value) < new Date(compareDate)) {
      alert('Ng√†y h·∫øt hi·ªáu l·ª±c ph·∫£i sau ng√†y c√≥ hi·ªáu l·ª±c!');
      this.value = '';
    }
  }
});
</script>
