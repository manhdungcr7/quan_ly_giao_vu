<%- contentFor('css') %>
<link rel="stylesheet" href="/css/documents.css">

<%- contentFor('content') %>
<div class="documents-page">
  <!-- Page Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">üìú VƒÉn b·∫£n ph√°p l√Ω</h1>
      <p style="color: #64748b; margin-top: 0.5rem;">Qu·∫£n l√Ω vƒÉn b·∫£n ph√°p l√Ω, quy ƒë·ªãnh v√† ngh·ªã ƒë·ªãnh</p>
    </div>
    <div class="page-actions">
      <a href="/legal-documents/create" class="btn btn-primary">
        <i class="fas fa-plus"></i> Th√™m vƒÉn b·∫£n m·ªõi
      </a>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-cards">
    <div class="stat-card stat-card--completed">
      <div class="stat-value"><%= stats.total %></div>
      <div class="stat-label">T·ªïng s·ªë</div>
    </div>
    <div class="stat-card stat-card--processing">
      <div class="stat-value"><%= stats.valid %></div>
      <div class="stat-label">C√≤n hi·ªáu l·ª±c</div>
    </div>
    <div class="stat-card stat-card--pending">
      <div class="stat-value"><%= stats.expired %></div>
      <div class="stat-label">H·∫øt hi·ªáu l·ª±c</div>
    </div>
    <div class="stat-card stat-card--overdue">
      <div class="stat-value"><%= stats.replaced %></div>
      <div class="stat-label">B·ªã thay th·∫ø</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-group">
      <label for="search">T√¨m ki·∫øm</label>
      <input type="text" id="search" name="search" placeholder="S·ªë hi·ªáu, ti√™u ƒë·ªÅ, c∆° quan..." value="<%= filters.search %>">
    </div>
    <div class="filter-group">
      <label for="type">Lo·∫°i vƒÉn b·∫£n</label>
      <select id="type" name="type">
        <option value="">-- T·∫•t c·∫£ --</option>
        <option value="Lu·∫≠t" <%= filters.type === 'Lu·∫≠t' ? 'selected' : '' %>>Lu·∫≠t</option>
        <option value="Ngh·ªã ƒë·ªãnh" <%= filters.type === 'Ngh·ªã ƒë·ªãnh' ? 'selected' : '' %>>Ngh·ªã ƒë·ªãnh</option>
        <option value="Th√¥ng t∆∞" <%= filters.type === 'Th√¥ng t∆∞' ? 'selected' : '' %>>Th√¥ng t∆∞</option>
        <option value="Quy·∫øt ƒë·ªãnh" <%= filters.type === 'Quy·∫øt ƒë·ªãnh' ? 'selected' : '' %>>Quy·∫øt ƒë·ªãnh</option>
        <option value="Quy ƒë·ªãnh" <%= filters.type === 'Quy ƒë·ªãnh' ? 'selected' : '' %>>Quy ƒë·ªãnh</option>
        <option value="Ngh·ªã quy·∫øt" <%= filters.type === 'Ngh·ªã quy·∫øt' ? 'selected' : '' %>>Ngh·ªã quy·∫øt</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="status">Tr·∫°ng th√°i</label>
      <select id="status" name="status">
        <option value="">-- T·∫•t c·∫£ --</option>
        <option value="C√≤n hi·ªáu l·ª±c" <%= filters.status === 'C√≤n hi·ªáu l·ª±c' ? 'selected' : '' %>>C√≤n hi·ªáu l·ª±c</option>
        <option value="H·∫øt hi·ªáu l·ª±c" <%= filters.status === 'H·∫øt hi·ªáu l·ª±c' ? 'selected' : '' %>>H·∫øt hi·ªáu l·ª±c</option>
        <option value="B·ªã thay th·∫ø" <%= filters.status === 'B·ªã thay th·∫ø' ? 'selected' : '' %>>B·ªã thay th·∫ø</option>
        <option value="D·ª± th·∫£o" <%= filters.status === 'D·ª± th·∫£o' ? 'selected' : '' %>>D·ª± th·∫£o</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="dateFrom">T·ª´ ng√†y</label>
      <input type="date" id="dateFrom" name="dateFrom" value="<%= filters.dateFrom %>">
    </div>
    <div class="filter-group">
      <label for="dateTo">ƒê·∫øn ng√†y</label>
      <input type="date" id="dateTo" name="dateTo" value="<%= filters.dateTo %>">
    </div>
    <div class="filter-actions">
      <button type="button" class="btn btn-sm btn-primary" id="applyFiltersBtn">
        <i class="fas fa-search"></i> L·ªçc
      </button>
      <button type="button" class="btn btn-sm btn-outline" id="clearFiltersBtn">
        <i class="fas fa-times"></i> X√≥a
      </button>
    </div>
  </div>

  <!-- Documents Table -->
  <div class="table-wrapper">
    <table class="doc-table">
      <thead>
        <tr>
          <th style="width: 140px;">S·ªë hi·ªáu</th>
          <th>Ti√™u ƒë·ªÅ</th>
          <th style="width: 110px;">Lo·∫°i</th>
          <th style="width: 150px;">C∆° quan</th>
          <th style="width: 130px;">Ng∆∞·ªùi k√Ω</th>
          <th style="width: 100px;">Ng√†y ban h√†nh</th>
          <th style="width: 45px;">File</th>
          <th style="width: 120px;">Tr·∫°ng th√°i</th>
          <th style="width: 130px;">Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <% if (documents.length === 0) { %>
          <tr>
            <td colspan="9" style="text-align: center; padding: 2rem; color: #6c757d;">
              Kh√¥ng c√≥ vƒÉn b·∫£n n√†o
            </td>
          </tr>
        <% } else { %>
          <% documents.forEach(function(doc) { %>
            <tr>
              <td><span class="mono"><%= doc.document_number %></span></td>
              <td class="title-cell">
                <div class="doc-title" title="<%= doc.summary || doc.title %>">
                  <%= doc.title %>
                </div>
                <% if (doc.keywords) { %>
                  <div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;">
                    üè∑Ô∏è <%= doc.keywords %>
                  </div>
                <% } %>
              </td>
              <td><%= doc.document_type %></td>
              <td><%= doc.issuing_authority %></td>
              <td>
                <% if (doc.signer_name) { %>
                  <div style="font-weight: 500; font-size: 0.875rem;"><%= doc.signer_name %></div>
                  <% if (doc.signer_position) { %>
                    <small style="color: #6c757d;"><%= doc.signer_position %></small>
                  <% } %>
                <% } else { %>
                  <span style="color: #adb5bd;">-</span>
                <% } %>
              </td>
              <td><%= doc.issue_date ? new Date(doc.issue_date).toLocaleDateString('vi-VN') : '-' %></td>
              <td style="text-align: center;">
                <span class="file-badge" title="File ƒë√≠nh k√®m">
                  <i class="fas fa-paperclip" style="color: #6c757d;"></i>
                </span>
              </td>
              <td>
                <% if (doc.status === 'C√≤n hi·ªáu l·ª±c') { %>
                  <span class="status-badge status-completed">‚úÖ C√≤n hi·ªáu l·ª±c</span>
                <% } else if (doc.status === 'H·∫øt hi·ªáu l·ª±c') { %>
                  <span class="status-badge status-pending">‚è≥ H·∫øt hi·ªáu l·ª±c</span>
                <% } else if (doc.status === 'B·ªã thay th·∫ø') { %>
                  <span class="status-badge status-processing">üîÑ B·ªã thay th·∫ø</span>
                <% } else if (doc.status === 'D·ª± th·∫£o') { %>
                  <span class="status-badge" style="background: #fff3cd; color: #856404;">üìù D·ª± th·∫£o</span>
                <% } else if (doc.status === 'ƒê√£ h·ªßy') { %>
                  <span class="status-badge status-overdue">‚ùå ƒê√£ h·ªßy</span>
                <% } else { %>
                  <span class="status-badge"><%= doc.status %></span>
                <% } %>
              </td>
              <td>
                <div class="action-buttons">
                  <a href="/legal-documents/<%= doc.id %>" class="icon-btn view-doc" title="Xem chi ti·∫øt">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="/legal-documents/<%= doc.id %>/edit" class="icon-btn edit-doc" title="S·ª≠a">
                    <i class="fas fa-edit"></i>
                  </a>
                  <button class="icon-btn delete-doc" data-id="<%= doc.id %>" title="X√≥a">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <% if (pagination.totalPages > 1) { %>
    <div class="pagination">
      <div class="pagination-info">
        Trang <%= pagination.page %> / <%= pagination.totalPages %> (T·ªïng: <%= pagination.total %> vƒÉn b·∫£n)
      </div>
      <div class="pagination-controls">
        <% if (pagination.page > 1) { %>
          <a href="?page=<%= pagination.page - 1 %>&<%= new URLSearchParams(filters).toString() %>" class="pg-btn">
            <i class="fas fa-chevron-left"></i>
          </a>
        <% } else { %>
          <span class="pg-btn disabled"><i class="fas fa-chevron-left"></i></span>
        <% } %>
        
        <% for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.totalPages, pagination.page + 2); i++) { %>
          <a href="?page=<%= i %>&<%= new URLSearchParams(filters).toString() %>" 
             class="pg-btn <%= i === pagination.page ? 'active' : '' %>">
            <%= i %>
          </a>
        <% } %>
        
        <% if (pagination.page < pagination.totalPages) { %>
          <a href="?page=<%= pagination.page + 1 %>&<%= new URLSearchParams(filters).toString() %>" class="pg-btn">
            <i class="fas fa-chevron-right"></i>
          </a>
        <% } else { %>
          <span class="pg-btn disabled"><i class="fas fa-chevron-right"></i></span>
        <% } %>
      </div>
    </div>
  <% } %>
</div>

<script>
function applyFilters() {
  const search = document.getElementById('search').value;
  const type = document.getElementById('type').value;
  const status = document.getElementById('status').value;
  const dateFrom = document.getElementById('dateFrom').value;
  const dateTo = document.getElementById('dateTo').value;
  
  const params = new URLSearchParams();
  if (search) params.append('search', search);
  if (type) params.append('type', type);
  if (status) params.append('status', status);
  if (dateFrom) params.append('dateFrom', dateFrom);
  if (dateTo) params.append('dateTo', dateTo);
  
  window.location.href = '/legal-documents?' + params.toString();
}

function clearFilters() {
  window.location.href = '/legal-documents';
}

function deleteDocument(id) {
  if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒÉn b·∫£n n√†y?')) return;
  
  fetch(`/legal-documents/${id}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('ƒê√£ x√≥a vƒÉn b·∫£n th√†nh c√¥ng');
      window.location.reload();
    } else {
      alert('L·ªói: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('C√≥ l·ªói x·∫£y ra khi x√≥a vƒÉn b·∫£n');
  });
}

// Event delegation cho n√∫t x√≥a
document.addEventListener('DOMContentLoaded', function() {
  // X·ª≠ l√Ω click cho t·∫•t c·∫£ n√∫t delete
  document.querySelectorAll('.delete-doc').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      deleteDocument(id);
    });
  });
  
  // N√∫t l·ªçc
  const applyBtn = document.getElementById('applyFiltersBtn');
  if (applyBtn) {
    applyBtn.addEventListener('click', applyFilters);
  }
  
  // N√∫t x√≥a filter
  const clearBtn = document.getElementById('clearFiltersBtn');
  if (clearBtn) {
    clearBtn.addEventListener('click', clearFilters);
  }
  
  // Enter key to search
  const searchInput = document.getElementById('search');
  if (searchInput) {
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        applyFilters();
      }
    });
  }
});
</script>
