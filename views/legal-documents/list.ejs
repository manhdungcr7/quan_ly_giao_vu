<% 
// Define breadcrumb for this page
breadcrumb = [
  { label: 'Trang ch·ªß', url: '/', icon: 'fa-home' },
  { label: 'VƒÉn b·∫£n ph√°p l√Ω', url: '/legal-documents', icon: 'fa-balance-scale' }
];
%>

<%- contentFor('css') %>
<link rel="stylesheet" href="/css/documents.css">

<%- contentFor('content') %>
<%- include('../partials/alerts') %>
<% const statusFilter = filters.status || ''; %>
<div class="documents-page">
  <section class="documents-toolbar" aria-label="ƒêi·ªÅu h∆∞·ªõng vƒÉn b·∫£n ph√°p l√Ω">
    <div class="documents-toolbar__cluster">
      <div class="documents-toolbar__badge" aria-hidden="true">
        <i class="fas fa-scale-balanced"></i>
      </div>
      <div class="documents-toolbar__meta">
        <span class="documents-toolbar__eyebrow">VƒÉn b·∫£n ph√°p l√Ω</span>
        <span class="documents-toolbar__title">Qu·∫£n l√Ω &amp; tra c·ª©u nhanh</span>
      </div>
      <div class="documents-toolbar__tabs" role="tablist">
        <a href="/legal-documents" class="documents-tab <%= statusFilter === '' ? 'documents-tab--active' : '' %>" role="tab" aria-selected="<%= statusFilter === '' ? 'true' : 'false' %>">
          <i class="fas fa-layer-group"></i>
          <span>T·∫•t c·∫£</span>
        </a>
        <a href="/legal-documents?status=<%= encodeURIComponent('C√≤n hi·ªáu l·ª±c') %>" class="documents-tab <%= statusFilter === 'C√≤n hi·ªáu l·ª±c' ? 'documents-tab--active' : '' %>" role="tab" aria-selected="<%= statusFilter === 'C√≤n hi·ªáu l·ª±c' ? 'true' : 'false' %>">
          <i class="fas fa-shield-check"></i>
          <span>C√≤n hi·ªáu l·ª±c</span>
        </a>
        <a href="/legal-documents?status=<%= encodeURIComponent('D·ª± th·∫£o') %>" class="documents-tab <%= statusFilter === 'D·ª± th·∫£o' ? 'documents-tab--active' : '' %>" role="tab" aria-selected="<%= statusFilter === 'D·ª± th·∫£o' ? 'true' : 'false' %>">
          <i class="fas fa-pen-nib"></i>
          <span>D·ª± th·∫£o</span>
        </a>
        <a href="/legal-documents?status=<%= encodeURIComponent('H·∫øt hi·ªáu l·ª±c') %>" class="documents-tab <%= statusFilter === 'H·∫øt hi·ªáu l·ª±c' ? 'documents-tab--active' : '' %>" role="tab" aria-selected="<%= statusFilter === 'H·∫øt hi·ªáu l·ª±c' ? 'true' : 'false' %>">
          <i class="fas fa-hourglass-end"></i>
          <span>H·∫øt hi·ªáu l·ª±c</span>
        </a>
        <a href="/legal-documents?status=<%= encodeURIComponent('B·ªã thay th·∫ø') %>" class="documents-tab <%= statusFilter === 'B·ªã thay th·∫ø' ? 'documents-tab--active' : '' %>" role="tab" aria-selected="<%= statusFilter === 'B·ªã thay th·∫ø' ? 'true' : 'false' %>">
          <i class="fas fa-repeat"></i>
          <span>B·ªã thay th·∫ø</span>
        </a>
      </div>
    </div>
    <div class="documents-toolbar__actions">
      <div class="documents-toolbar__stat">
        <span class="documents-toolbar__stat-label">T·ªïng</span>
        <span class="documents-toolbar__stat-value"><%= stats.total %></span>
      </div>
      <a href="/legal-documents/create" class="documents-toolbar__cta">
        <i class="fas fa-plus"></i>
        <span>Th√™m vƒÉn b·∫£n</span>
      </a>
    </div>
  </section>

  <div class="documents-kpis">
    <div class="documents-kpi documents-kpi--completed">
      <span class="documents-kpi__value"><%= stats.total %></span>
      <span class="documents-kpi__label">T·ªïng s·ªë</span>
    </div>
    <div class="documents-kpi documents-kpi--processing">
      <span class="documents-kpi__value"><%= stats.valid %></span>
      <span class="documents-kpi__label">C√≤n hi·ªáu l·ª±c</span>
    </div>
    <div class="documents-kpi documents-kpi--pending">
      <span class="documents-kpi__value"><%= stats.expired %></span>
      <span class="documents-kpi__label">H·∫øt hi·ªáu l·ª±c</span>
    </div>
    <div class="documents-kpi documents-kpi--overdue">
      <span class="documents-kpi__value"><%= stats.replaced %></span>
      <span class="documents-kpi__label">B·ªã thay th·∫ø</span>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters filters--legal">
    <div class="filters__intro">
      <div class="filters__intro-text">
        <span class="filters__intro-label">B·ªô l·ªçc n√¢ng cao</span>
        <p>Thu h·∫πp danh s√°ch theo lo·∫°i vƒÉn b·∫£n, tr·∫°ng th√°i ho·∫∑c kho·∫£ng th·ªùi gian.</p>
      </div>
      <div class="filters__intro-chip">
        <i class="fas fa-sliders-h"></i>
        <span><%= statusFilter || 'T·∫•t c·∫£ tr·∫°ng th√°i' %></span>
      </div>
    </div>
    <div class="filter-group">
      <label for="search">T·ª´ kh√≥a</label>
      <input type="text" id="search" name="search" placeholder="S·ªë hi·ªáu, ti√™u ƒë·ªÅ, c∆° quan..." value="<%= filters.search %>">
    </div>
    <div class="filter-group">
      <label for="type">Lo·∫°i vƒÉn b·∫£n</label>
      <select id="type" name="type">
        <option value="">-- T·∫•t c·∫£ --</option>
        <option value="Lu·∫≠t" <%= filters.type === 'Lu·∫≠t' ? 'selected' : '' %>>Lu·∫≠t</option>
        <option value="Ngh·ªã ƒë·ªãnh" <%= filters.type === 'Ngh·ªã ƒë·ªãnh' ? 'selected' : '' %>>Ngh·ªã ƒë·ªãnh</option>
        <option value="Th√¥ng t∆∞" <%= filters.type === 'Th√¥ng t∆∞' ? 'selected' : '' %>>Th√¥ng t∆∞</option>
        <option value="Quy·∫øt ƒë·ªãnh" <%= filters.type === 'Quy·∫øt ƒë·ªãnh' ? 'selected' : '' %>>Quy·∫øt ƒë·ªãnh</option>
        <option value="Quy ƒë·ªãnh" <%= filters.type === 'Quy ƒë·ªãnh' ? 'selected' : '' %>>Quy ƒë·ªãnh</option>
        <option value="Ngh·ªã quy·∫øt" <%= filters.type === 'Ngh·ªã quy·∫øt' ? 'selected' : '' %>>Ngh·ªã quy·∫øt</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="status">Tr·∫°ng th√°i</label>
      <select id="status" name="status">
        <option value="">-- T·∫•t c·∫£ --</option>
        <option value="C√≤n hi·ªáu l·ª±c" <%= filters.status === 'C√≤n hi·ªáu l·ª±c' ? 'selected' : '' %>>C√≤n hi·ªáu l·ª±c</option>
        <option value="H·∫øt hi·ªáu l·ª±c" <%= filters.status === 'H·∫øt hi·ªáu l·ª±c' ? 'selected' : '' %>>H·∫øt hi·ªáu l·ª±c</option>
        <option value="B·ªã thay th·∫ø" <%= filters.status === 'B·ªã thay th·∫ø' ? 'selected' : '' %>>B·ªã thay th·∫ø</option>
        <option value="D·ª± th·∫£o" <%= filters.status === 'D·ª± th·∫£o' ? 'selected' : '' %>>D·ª± th·∫£o</option>
      </select>
    </div>
    <div class="filter-group">
      <label for="dateFrom">T·ª´ ng√†y</label>
      <input type="date" id="dateFrom" name="dateFrom" value="<%= filters.dateFrom %>">
    </div>
    <div class="filter-group">
      <label for="dateTo">ƒê·∫øn ng√†y</label>
      <input type="date" id="dateTo" name="dateTo" value="<%= filters.dateTo %>">
    </div>
    <div class="filter-actions">
      <button type="button" class="btn btn-sm btn-primary" id="applyFiltersBtn">
        <i class="fas fa-search"></i> L·ªçc
      </button>
      <button type="button" class="btn btn-sm btn-outline" id="clearFiltersBtn">
        <i class="fas fa-times"></i> X√≥a
      </button>
    </div>
  </div>

  <!-- Documents Table -->
  <div class="table-wrapper">
    <table class="doc-table">
      <thead>
        <tr>
          <th style="width: 140px;">S·ªë hi·ªáu</th>
          <th>Ti√™u ƒë·ªÅ</th>
          <th style="width: 110px;">Lo·∫°i</th>
          <th style="width: 150px;">C∆° quan</th>
          <th style="width: 130px;">Ng∆∞·ªùi k√Ω</th>
          <th style="width: 100px;">Ng√†y ban h√†nh</th>
          <th style="width: 45px;">File</th>
          <th style="width: 120px;">Tr·∫°ng th√°i</th>
          <th style="width: 130px;">Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <% if (documents.length === 0) { %>
          <tr>
            <td colspan="9" style="text-align: center; padding: 2rem; color: #6c757d;">
              Kh√¥ng c√≥ vƒÉn b·∫£n n√†o
            </td>
          </tr>
        <% } else { %>
          <% documents.forEach(function(doc) { %>
            <tr>
              <td><span class="mono"><%= doc.document_number %></span></td>
              <td class="title-cell">
                <div class="doc-title" title="<%= doc.summary || doc.title %>">
                  <%= doc.title %>
                </div>
                <% if (doc.keywords) { %>
                  <div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;">
                    üè∑Ô∏è <%= doc.keywords %>
                  </div>
                <% } %>
              </td>
              <td><%= doc.document_type %></td>
              <td><%= doc.issuing_authority %></td>
              <td>
                <% if (doc.signer_name) { %>
                  <div style="font-weight: 500; font-size: 0.875rem;"><%= doc.signer_name %></div>
                  <% if (doc.signer_position) { %>
                    <small style="color: #6c757d;"><%= doc.signer_position %></small>
                  <% } %>
                <% } else { %>
                  <span style="color: #adb5bd;">-</span>
                <% } %>
              </td>
              <td><%= doc.issue_date ? new Date(doc.issue_date).toLocaleDateString('vi-VN') : '-' %></td>
              <td style="text-align: center;">
                <span class="file-badge" title="File ƒë√≠nh k√®m">
                  <i class="fas fa-paperclip" style="color: #6c757d;"></i>
                </span>
              </td>
              <td>
                <% if (doc.status === 'C√≤n hi·ªáu l·ª±c') { %>
                  <span class="status-badge status-completed">‚úÖ C√≤n hi·ªáu l·ª±c</span>
                <% } else if (doc.status === 'H·∫øt hi·ªáu l·ª±c') { %>
                  <span class="status-badge status-pending">‚è≥ H·∫øt hi·ªáu l·ª±c</span>
                <% } else if (doc.status === 'B·ªã thay th·∫ø') { %>
                  <span class="status-badge status-processing">üîÑ B·ªã thay th·∫ø</span>
                <% } else if (doc.status === 'D·ª± th·∫£o') { %>
                  <span class="status-badge" style="background: #fff3cd; color: #856404;">üìù D·ª± th·∫£o</span>
                <% } else if (doc.status === 'ƒê√£ h·ªßy') { %>
                  <span class="status-badge status-overdue">‚ùå ƒê√£ h·ªßy</span>
                <% } else { %>
                  <span class="status-badge"><%= doc.status %></span>
                <% } %>
              </td>
              <td>
                <div class="action-buttons">
                  <a href="/legal-documents/<%= doc.id %>"
                     class="icon-btn icon-btn--sky view-doc"
                     title="Xem chi ti·∫øt"
                     aria-label="Xem vƒÉn b·∫£n <%= doc.document_number %>">
                    <svg viewBox="0 0 20 20" aria-hidden="true" focusable="false" class="icon-svg">
                      <path fill="currentColor" d="M10 4.5c-4.5 0-7.5 5.5-7.5 5.5s3 5.5 7.5 5.5 7.5-5.5 7.5-5.5-3-5.5-7.5-5.5Zm0 9a3.5 3.5 0 1 1 3.5-3.5A3.5 3.5 0 0 1 10 13.5Zm0-5a1.5 1.5 0 1 0 1.5 1.5A1.5 1.5 0 0 0 10 8.5Z"/>
                    </svg>
                  </a>
                  <a href="/legal-documents/<%= doc.id %>/edit"
                     class="icon-btn icon-btn--amber edit-doc"
                     title="Ch·ªânh s·ª≠a"
                     aria-label="Ch·ªânh s·ª≠a vƒÉn b·∫£n <%= doc.document_number %>">
                    <svg viewBox="0 0 20 20" aria-hidden="true" focusable="false" class="icon-svg">
                      <path fill="currentColor" d="M12.59 2.59a2 2 0 0 1 2.82 0l1.99 1.99a2 2 0 0 1 0 2.82l-8.6 8.6a2 2 0 0 1-.94.53l-4 1a1 1 0 0 1-1.21-1.21l1-4a2 2 0 0 1 .52-.94zM13 5l-8 8-.5 2 2-.5 8-8z"/>
                    </svg>
                  </a>
                  <button class="icon-btn icon-btn--rose delete-doc"
                          data-id="<%= doc.id %>"
                          title="X√≥a"
                          aria-label="X√≥a vƒÉn b·∫£n <%= doc.document_number %>">
                    <svg viewBox="0 0 20 20" aria-hidden="true" focusable="false" class="icon-svg">
                      <path fill="currentColor" d="M7.5 3a1.5 1.5 0 0 1 1.5-1.5h2a1.5 1.5 0 0 1 1.5 1.5H15a1 1 0 0 1 0 2h-.5v9.5A2.5 2.5 0 0 1 12 17h-4a2.5 2.5 0 0 1-2.5-2.5V5H5a1 1 0 0 1 0-2zm1 2v9.5a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5V5zM9 8a1 1 0 0 1 2 0v5a1 1 0 1 1-2 0z"/>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <% if (pagination.totalPages > 1) { %>
    <div class="pagination">
      <div class="pagination-info">
        Trang <%= pagination.page %> / <%= pagination.totalPages %> (T·ªïng: <%= pagination.total %> vƒÉn b·∫£n)
      </div>
      <div class="pagination-controls">
        <% if (pagination.page > 1) { %>
          <a href="?page=<%= pagination.page - 1 %>&<%= new URLSearchParams(filters).toString() %>" class="pg-btn">
            <i class="fas fa-chevron-left"></i>
          </a>
        <% } else { %>
          <span class="pg-btn disabled"><i class="fas fa-chevron-left"></i></span>
        <% } %>
        
        <% for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.totalPages, pagination.page + 2); i++) { %>
          <a href="?page=<%= i %>&<%= new URLSearchParams(filters).toString() %>" 
             class="pg-btn <%= i === pagination.page ? 'active' : '' %>">
            <%= i %>
          </a>
        <% } %>
        
        <% if (pagination.page < pagination.totalPages) { %>
          <a href="?page=<%= pagination.page + 1 %>&<%= new URLSearchParams(filters).toString() %>" class="pg-btn">
            <i class="fas fa-chevron-right"></i>
          </a>
        <% } else { %>
          <span class="pg-btn disabled"><i class="fas fa-chevron-right"></i></span>
        <% } %>
      </div>
    </div>
  <% } %>
</div>

<script>
function applyFilters() {
  const search = document.getElementById('search').value;
  const type = document.getElementById('type').value;
  const status = document.getElementById('status').value;
  const dateFrom = document.getElementById('dateFrom').value;
  const dateTo = document.getElementById('dateTo').value;
  
  const params = new URLSearchParams();
  if (search) params.append('search', search);
  if (type) params.append('type', type);
  if (status) params.append('status', status);
  if (dateFrom) params.append('dateFrom', dateFrom);
  if (dateTo) params.append('dateTo', dateTo);
  
  window.location.href = '/legal-documents?' + params.toString();
}

function clearFilters() {
  window.location.href = '/legal-documents';
}

function deleteDocument(id) {
  if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒÉn b·∫£n n√†y?')) return;
  
  fetch(`/legal-documents/${id}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('ƒê√£ x√≥a vƒÉn b·∫£n th√†nh c√¥ng');
      window.location.reload();
    } else {
      alert('L·ªói: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('C√≥ l·ªói x·∫£y ra khi x√≥a vƒÉn b·∫£n');
  });
}

// Event delegation cho n√∫t x√≥a
document.addEventListener('DOMContentLoaded', function() {
  // X·ª≠ l√Ω click cho t·∫•t c·∫£ n√∫t delete
  document.querySelectorAll('.delete-doc').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      deleteDocument(id);
    });
  });
  
  // N√∫t l·ªçc
  const applyBtn = document.getElementById('applyFiltersBtn');
  if (applyBtn) {
    applyBtn.addEventListener('click', applyFilters);
  }
  
  // N√∫t x√≥a filter
  const clearBtn = document.getElementById('clearFiltersBtn');
  if (clearBtn) {
    clearBtn.addEventListener('click', clearFilters);
  }
  
  // Enter key to search
  const searchInput = document.getElementById('search');
  if (searchInput) {
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        applyFilters();
      }
    });
  }
});
</script>
