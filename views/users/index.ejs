<%
breadcrumb = [
    { label: 'Trang chủ', url: '/dashboard', icon: 'fa-house' },
    { label: 'Quản lý người dùng', url: '/users', icon: 'fa-users' }
];

const currentUserRoleName = user && (user.role_name || user.roleName);
const isAdminView = currentUserRoleName && currentUserRoleName.toString().toLowerCase() === 'admin';

const pendingTotal = typeof pendingCount === 'number' ? pendingCount : 0;
const safeSearch = typeof search === 'string' ? search.trim() : '';

const filterStatus = filters && typeof filters.status === 'string' ? filters.status : '';
const filterApproval = filters && typeof filters.approval === 'string' ? filters.approval : '';
const filterRole = filters && typeof filters.role === 'string' ? filters.role : '';

const hasPagination = pagination && Number.isFinite(pagination.totalPages) && pagination.totalPages > 0;
const currentPage = hasPagination && Number.isFinite(pagination.page) && pagination.page > 0 ? pagination.page : 1;
const pageLimit = hasPagination && Number.isFinite(pagination.limit) && pagination.limit > 0 ? pagination.limit : 20;
const totalUsers = pagination && Number.isFinite(pagination.total) ? pagination.total : (Array.isArray(users) ? users.length : 0);
const totalPages = hasPagination ? pagination.totalPages : Math.max(1, Math.ceil(totalUsers / pageLimit));
const hasUsers = Array.isArray(users) && users.length > 0;

const startIndex = hasUsers ? ((currentPage - 1) * pageLimit) + 1 : 0;
const endIndex = hasUsers ? Math.min(currentPage * pageLimit, totalUsers) : 0;

const commonQueryParts = [
    `limit=${encodeURIComponent(pageLimit || 20)}`,
    `search=${encodeURIComponent(safeSearch || '')}`,
    `status=${encodeURIComponent(filterStatus || '')}`,
    `role=${encodeURIComponent(filterRole || '')}`
];

const buildPageLink = (pageNumber, approvalValue = filterApproval) => {
    const params = [
        `page=${pageNumber}`,
        ...commonQueryParts,
        `approval_status=${encodeURIComponent(approvalValue || '')}`
    ];
    return `?${params.join('&')}`;
};

const pendingOnlyLink = buildPageLink(1, approvalStatuses.PENDING);
%>

<%- contentFor('css') %>
<link rel="stylesheet" href="/css/users.css?v=20241011">

<%- contentFor('js') %>
<script src="/js/users-approval.js?v=20241011" defer></script>

<%- contentFor('content') %>
<div class="users-page">
    <section class="users-page__header">
        <div class="users-page__headline">
            <h1 class="users-page__title">
                <span class="users-page__title-icon"><i class="fas fa-users"></i></span>
                Quản lý người dùng
            </h1>
            <p class="users-page__subtitle">Theo dõi trạng thái tài khoản và xử lý yêu cầu phê duyệt nhanh chóng.</p>
        </div>
        <div class="users-page__summary">
            <div class="users-page__pending" aria-live="polite">
                <span class="users-page__pending-icon"><i class="fas fa-hourglass-half"></i></span>
                <div class="users-page__pending-text">
                    <span class="users-page__pending-label">Đang chờ phê duyệt</span>
                    <strong class="users-page__pending-count"><%= pendingTotal %></strong>
                </div>
            </div>
            <% if (isAdminView) { %>
                <a href="/auth/register" class="users-page__create btn-primary">
                    <i class="fas fa-user-plus"></i>
                    Tạo tài khoản mới
                </a>
            <% } %>
        </div>
    </section>

    <section class="users-filters" aria-label="Bộ lọc người dùng">
        <form class="users-filters__form" method="GET">
            <div class="users-filters__grid">
                <div class="users-filters__field users-filters__field--keyword">
                    <label class="users-filters__label" for="search">Từ khóa</label>
                    <div class="users-filters__control">
                        <span class="users-filters__icon"><i class="fas fa-search"></i></span>
                        <input class="users-filters__input" type="text" id="search" name="search" value="<%= safeSearch %>" placeholder="Họ tên, email hoặc tên đăng nhập">
                    </div>
                </div>
                <div class="users-filters__field">
                    <label class="users-filters__label" for="role">Vai trò</label>
                    <select class="users-filters__select" id="role" name="role">
                        <option value="">Tất cả vai trò</option>
                        <% if (roleOptions && roleOptions.length) { %>
                            <% roleOptions.forEach(function(role){ %>
                                <option value="<%= role.id %>" <%= filterRole === String(role.id) ? 'selected' : '' %>>
                                    <%= (roleLabels && roleLabels[role.name]) ? roleLabels[role.name] : role.name %>
                                </option>
                            <% }); %>
                        <% } %>
                    </select>
                </div>
                <div class="users-filters__field">
                    <label class="users-filters__label" for="status">Trạng thái kích hoạt</label>
                    <select class="users-filters__select" id="status" name="status">
                        <option value="">Tất cả</option>
                        <option value="active" <%= filterStatus === 'active' ? 'selected' : '' %>>Hoạt động</option>
                        <option value="inactive" <%= filterStatus === 'inactive' ? 'selected' : '' %>>Không hoạt động</option>
                    </select>
                </div>
                <div class="users-filters__field">
                    <label class="users-filters__label" for="approval_status">Trạng thái phê duyệt</label>
                    <select class="users-filters__select" id="approval_status" name="approval_status">
                        <option value="">Tất cả</option>
                        <option value="<%= approvalStatuses.PENDING %>" <%= filterApproval === approvalStatuses.PENDING ? 'selected' : '' %>>Chờ xử lý</option>
                        <option value="<%= approvalStatuses.APPROVED %>" <%= filterApproval === approvalStatuses.APPROVED ? 'selected' : '' %>>Đã phê duyệt</option>
                        <option value="<%= approvalStatuses.REJECTED %>" <%= filterApproval === approvalStatuses.REJECTED ? 'selected' : '' %>>Bị từ chối</option>
                    </select>
                </div>
            </div>

            <div class="users-filters__actions">
                <button type="submit" class="users-filters__submit btn-outline">
                    <i class="fas fa-filter"></i>
                    Lọc kết quả
                </button>
                <a href="/users" class="users-filters__reset">
                    <i class="fas fa-undo-alt"></i>
                    Xóa lọc
                </a>
                <% if (filterApproval !== approvalStatuses.PENDING) { %>
                    <a href="<%= pendingOnlyLink %>" class="users-filters__quick">
                        <i class="fas fa-hourglass"></i>
                        Xem tài khoản chờ duyệt
                    </a>
                <% } %>
            </div>
        </form>
    </section>

    <section class="users-table" aria-label="Danh sách người dùng">
        <header class="users-table__header">
            <div>
                <h2 class="users-table__title"><i class="fas fa-table"></i> Danh sách tài khoản</h2>
                <p class="users-table__meta">Hiển thị <strong><%= startIndex %></strong> - <strong><%= endIndex %></strong> trên tổng số <strong><%= totalUsers %></strong> tài khoản.</p>
            </div>
            <% if (hasUsers) { %>
                <span class="users-table__hint">Các tài khoản mới tạo hiển thị ở đầu danh sách.</span>
            <% } %>
        </header>

        <div class="users-table__body">
            <% if (hasUsers) { %>
                <div class="users-table__scroll">
                    <table class="users-table__table" aria-describedby="users-table-caption">
                        <caption id="users-table-caption" class="visually-hidden">Danh sách người dùng theo bộ lọc hiện tại</caption>
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Họ và tên</th>
                                <th scope="col">Tài khoản</th>
                                <th scope="col">Vai trò</th>
                                <th scope="col">Phê duyệt</th>
                                <th scope="col">Kích hoạt</th>
                                <th scope="col">Ngày tạo</th>
                                <th scope="col" class="users-table__column-actions">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% users.forEach(function(item, index){
                                const approvalStatus = item.approval_status || '';
                                const isPending = approvalStatus === approvalStatuses.PENDING;
                                const isRejected = approvalStatus === approvalStatuses.REJECTED;
                                let approvalLabel = 'Chưa xác định';
                                let approvalClass = 'muted';
                                let approvalIcon = 'question-circle';

                                if (approvalStatus === approvalStatuses.PENDING) {
                                    approvalLabel = 'Chờ xử lý';
                                    approvalClass = 'pending';
                                    approvalIcon = 'hourglass-half';
                                } else if (approvalStatus === approvalStatuses.APPROVED) {
                                    approvalLabel = 'Đã phê duyệt';
                                    approvalClass = 'success';
                                    approvalIcon = 'check-circle';
                                } else if (approvalStatus === approvalStatuses.REJECTED) {
                                    approvalLabel = 'Bị từ chối';
                                    approvalClass = 'danger';
                                    approvalIcon = 'times-circle';
                                }
                            %>
                                <tr class="users-table__row <%= isPending ? 'is-pending' : '' %>">
                                    <td data-title="#">
                                        <%= ((currentPage - 1) * pageLimit) + index + 1 %>
                                    </td>
                                    <td data-title="Họ và tên">
                                        <div class="users-table__name">
                                            <i class="fas fa-user-circle"></i>
                                            <div>
                                                <div class="users-table__primary"><%= item.full_name %></div>
                                                <div class="users-table__secondary"><i class="fas fa-envelope"></i> <%= item.email %></div>
                                                <% if (item.phone) { %>
                                                    <div class="users-table__secondary"><i class="fas fa-phone"></i> <%= item.phone %></div>
                                                <% } %>
                                            </div>
                                        </div>
                                    </td>
                                    <td data-title="Tài khoản">
                                        <div class="users-table__primary"><i class="fas fa-id-badge"></i> <%= item.username %></div>
                                        <% if (item.last_login) { %>
                                            <div class="users-table__secondary"><i class="fas fa-clock"></i> <%= new Date(item.last_login).toLocaleString('vi-VN') %></div>
                                        <% } %>
                                    </td>
                                    <td data-title="Vai trò">
                                        <span class="users-tag users-tag--role">
                                            <i class="fas fa-user-shield"></i>
                                            <%= (roleLabels && item.role_name && roleLabels[item.role_name]) ? roleLabels[item.role_name] : (item.role_name || 'Chưa gán') %>
                                        </span>
                                    </td>
                                    <td data-title="Phê duyệt">
                                        <span class="users-badge users-badge--<%= approvalClass %>" <%= isRejected && item.rejected_reason ? 'title="' + item.rejected_reason + '"' : '' %>>
                                            <i class="fas fa-<%= approvalIcon %>"></i>
                                            <%= approvalLabel %>
                                        </span>
                                        <% if (item.approver_name && approvalStatus === approvalStatuses.APPROVED) { %>
                                            <div class="users-table__secondary">Bởi: <%= item.approver_name %></div>
                                        <% } %>
                                    </td>
                                    <td data-title="Kích hoạt">
                                        <span class="users-badge users-badge--<%= item.is_active ? 'success' : 'muted' %>">
                                            <i class="fas fa-<%= item.is_active ? 'toggle-on' : 'toggle-off' %>"></i>
                                            <%= item.is_active ? 'Hoạt động' : 'Không hoạt động' %>
                                        </span>
                                    </td>
                                    <td data-title="Ngày tạo">
                                        <div class="users-table__primary"><i class="fas fa-calendar-plus"></i> <%= item.created_at ? new Date(item.created_at).toLocaleDateString('vi-VN') : '-' %></div>
                                        <% if (item.approved_at) { %>
                                            <div class="users-table__secondary"><i class="fas fa-check"></i> <%= new Date(item.approved_at).toLocaleDateString('vi-VN') %></div>
                                        <% } %>
                                    </td>
                                    <td data-title="Thao tác" class="users-table__actions-cell">
                                        <% if (isPending && isAdminView) { %>
                                            <div class="users-approve">
                                                <form method="POST" action="/users/<%= item.id %>/approve" class="users-approve__form">
                                                    <label class="visually-hidden" for="approve-role-<%= item.id %>">Chọn vai trò khi phê duyệt</label>
                                                    <select id="approve-role-<%= item.id %>" name="role_id" class="users-approve__select" required>
                                                        <% if (roleOptions && roleOptions.length) { %>
                                                            <% roleOptions.forEach(function(role){ %>
                                                                <option value="<%= role.id %>" <%= item.role_id === role.id ? 'selected' : '' %>>
                                                                    <%= (roleLabels && roleLabels[role.name]) ? roleLabels[role.name] : role.name %>
                                                                </option>
                                                            <% }); %>
                                                        <% } %>
                                                    </select>
                                                    <button type="submit" class="users-approve__button">
                                                        <i class="fas fa-check"></i>
                                                        Phê duyệt
                                                    </button>
                                                </form>
                                                <form method="POST" action="/users/<%= item.id %>/reject" class="users-reject" data-user-name="<%= item.full_name %>">
                                                    <input type="hidden" name="reason" value="">
                                                    <button type="button" class="users-reject__button js-users-reject">
                                                        <i class="fas fa-times"></i>
                                                        Từ chối
                                                    </button>
                                                </form>
                                            </div>
                                        <% } else { %>
                                            <div class="users-row-actions">
                                                <a class="users-row-actions__button" href="/users/<%= item.id %>" title="Xem chi tiết">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <% if (isAdminView) { %>
                                                    <a class="users-row-actions__button" href="/users/<%= item.id %>/edit" title="Chỉnh sửa">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                <% } %>
                                            </div>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            <% } else { %>
                <div class="users-table__empty">
                    <i class="fas fa-inbox"></i>
                    <p>Không tìm thấy người dùng phù hợp với bộ lọc hiện tại.</p>
                    <a class="users-table__empty-reset" href="/users"><i class="fas fa-sync"></i> Làm mới danh sách</a>
                </div>
            <% } %>
        </div>

        <% if (totalPages > 1) { %>
            <nav class="users-pagination" aria-label="Phân trang tài khoản">
                <a class="users-pagination__button <%= currentPage <= 1 ? 'is-disabled' : '' %>" href="<%= currentPage <= 1 ? '#' : buildPageLink(currentPage - 1) %>">
                    <i class="fas fa-chevron-left"></i>
                    Trước
                </a>
                <ul class="users-pagination__pages">
                    <% for (let page = 1; page <= totalPages; page++) { %>
                        <li>
                            <a class="users-pagination__page <%= page === currentPage ? 'is-active' : '' %>" href="<%= buildPageLink(page) %>">
                                <%= page %>
                            </a>
                        </li>
                    <% } %>
                </ul>
                <a class="users-pagination__button <%= currentPage >= totalPages ? 'is-disabled' : '' %>" href="<%= currentPage >= totalPages ? '#' : buildPageLink(currentPage + 1) %>">
                    Sau
                    <i class="fas fa-chevron-right"></i>
                </a>
            </nav>
        <% } %>
    </section>
</div>