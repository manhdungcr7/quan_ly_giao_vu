<%
breadcrumb = [
    { label: 'Trang chủ', url: '/dashboard', icon: 'fa-house' },
    { label: 'Quản lý người dùng', url: '/users', icon: 'fa-users' },
    { label: 'Chi tiết tài khoản', url: '/users/' + (userDetail ? userDetail.id : ''), icon: 'fa-id-card' }
];

const detail = userDetail || {};
const sessionUser = user || {};
const roleValue = (detail.role_name || detail.roleName || '').toString().trim().toLowerCase();
const roleLabels = {
    admin: 'Quản trị viên',
    staff: 'Cán bộ',
    lecturer: 'Giảng viên',
    viewer: 'Người xem',
    guest: 'Khách',
    department_head: 'Trưởng khoa',
    deputy_department_head: 'Phó trưởng khoa',
    board: 'Ban giám hiệu'
};
const approvalLabels = {
    pending: 'Chờ phê duyệt',
    approved: 'Đã phê duyệt',
    rejected: 'Từ chối'
};
const statusBadges = {
    true: { label: 'Hoạt động', className: 'badge--success' },
    false: { label: 'Bị khóa', className: 'badge--danger' }
};
const approvalBadgeStyles = {
    pending: 'badge--warning',
    approved: 'badge--success',
    rejected: 'badge--danger'
};
const resolvedRoleLabel = roleLabels[roleValue] || detail.role_name || 'Không xác định';
const isAdminView = (sessionUser.role_name || sessionUser.roleName || '').toString().trim().toLowerCase() === 'admin';
const canEdit = isAdminView || sessionUser.id === detail.id;
const momentLib = typeof moment === 'function' ? moment : null;
const formatDate = (value, fmt = 'DD/MM/YYYY HH:mm') => {
    if (!value) return '—';
    try {
        return momentLib ? momentLib(value).format(fmt) : value;
    } catch (_) {
        return value;
    }
};
const safe = (value) => (value === null || typeof value === 'undefined' || value === '' ? '—' : value);
const statusKey = detail.is_active ? 'true' : 'false';
const statusMeta = statusBadges[statusKey] || statusBadges.true;
const approvalKey = (detail.approval_status || '').toString().trim().toLowerCase();
const approvalLabel = approvalLabels[approvalKey] || safe(detail.approval_status);
const approvalStyle = approvalBadgeStyles[approvalKey] || 'badge--neutral';
%>

<%- contentFor('css') %>
<style>
.user-show {
    max-width: 820px;
    margin: 2rem auto;
    background: #ffffff;
    border-radius: 20px;
    padding: 2.25rem 2.75rem;
    box-shadow: 0 28px 56px rgba(15, 23, 42, 0.12);
}
.user-show__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1.5rem;
    margin-bottom: 2rem;
}
.user-show__title {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 700;
    color: #0f172a;
}
.user-show__subtitle {
    margin: 0.5rem 0 0;
    color: #475569;
    font-size: 0.95rem;
}
.user-show__actions {
    display: flex;
    gap: 0.75rem;
}
.user-show__actions a,
.user-show__actions button {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.7rem 1.3rem;
    border-radius: 999px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    text-decoration: none;
}
.user-show__actions a {
    background: #e0e7ff;
    color: #1d4ed8;
}
.user-show__actions a:hover {
    background: #c7d2fe;
}
.user-show__actions .user-show__edit {
    background: #2563eb;
    color: #ffffff;
}
.user-show__actions .user-show__edit:hover {
    background: #1d4ed8;
}
.user-show__meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}
.user-show__card {
    background: #f8fafc;
    border-radius: 16px;
    padding: 1.5rem;
}
.user-show__card-title {
    margin: 0 0 1rem;
    font-size: 0.95rem;
    font-weight: 700;
    letter-spacing: 0.02em;
    color: #475569;
    text-transform: uppercase;
}
.user-show__row {
    display: grid;
    grid-template-columns: 140px 1fr;
    gap: 0.75rem;
    padding: 0.5rem 0;
}
.user-show__label {
    color: #64748b;
    font-weight: 600;
}
.user-show__value {
    color: #0f172a;
    word-break: break-word;
}
.badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.8rem;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
}
.badge--success {
    background: rgba(34, 197, 94, 0.13);
    color: #15803d;
}
.badge--danger {
    background: rgba(239, 68, 68, 0.14);
    color: #b91c1c;
}
.badge--warning {
    background: rgba(251, 191, 36, 0.16);
    color: #b45309;
}
.badge--neutral {
    background: rgba(148, 163, 184, 0.2);
    color: #475569;
}
.user-show__section-title {
    margin: 0 0 1rem;
    font-size: 1.05rem;
    font-weight: 700;
    color: #1e293b;
}
.user-show__notes {
    margin-top: 1.5rem;
    padding: 1.2rem 1.5rem;
    border-radius: 14px;
    background: #f1f5f9;
    color: #475569;
    line-height: 1.55;
}
</style>

<%- contentFor('content') %>
<div class="user-show">
    <div class="user-show__header">
        <div>
            <h1 class="user-show__title">Hồ sơ tài khoản</h1>
            <p class="user-show__subtitle">Chi tiết thông tin của tài khoản <strong><%= safe(detail.username) %></strong>.</p>
        </div>
        <div class="user-show__actions">
            <a href="/users">
                ← Trở về danh sách
            </a>
            <% if (canEdit) { %>
                <a class="user-show__edit" href="/users/<%= detail.id %>/edit">✏️ Chỉnh sửa</a>
            <% } %>
        </div>
    </div>

    <div class="user-show__meta">
        <section class="user-show__card">
            <h2 class="user-show__card-title">Thông tin liên hệ</h2>
            <div class="user-show__row">
                <div class="user-show__label">Họ và tên</div>
                <div class="user-show__value"><%= safe(detail.full_name) %></div>
            </div>
            <div class="user-show__row">
                <div class="user-show__label">Email</div>
                <div class="user-show__value"><%= safe(detail.email) %></div>
            </div>
            <div class="user-show__row">
                <div class="user-show__label">Số điện thoại</div>
                <div class="user-show__value"><%= safe(detail.phone) %></div>
            </div>
        </section>
        <section class="user-show__card">
            <h2 class="user-show__card-title">Trạng thái hệ thống</h2>
            <div class="user-show__row">
                <div class="user-show__label">Vai trò</div>
                <div class="user-show__value"><%= resolvedRoleLabel %></div>
            </div>
            <div class="user-show__row">
                <div class="user-show__label">Trạng thái</div>
                <div class="user-show__value"><span class="badge <%= statusMeta.className %>"><%= statusMeta.label %></span></div>
            </div>
            <div class="user-show__row">
                <div class="user-show__label">Phê duyệt</div>
                <div class="user-show__value"><span class="badge <%= approvalStyle %>"><%= approvalLabel %></span></div>
            </div>
        </section>
    </div>

    <section class="user-show__card">
        <h2 class="user-show__section-title">Lịch sử hoạt động</h2>
        <div class="user-show__row">
            <div class="user-show__label">Đăng nhập gần nhất</div>
            <div class="user-show__value"><%= formatDate(detail.last_login) %></div>
        </div>
        <div class="user-show__row">
            <div class="user-show__label">Ngày tạo</div>
            <div class="user-show__value"><%= formatDate(detail.created_at, 'DD/MM/YYYY HH:mm') %></div>
        </div>
        <div class="user-show__row">
            <div class="user-show__label">Cập nhật gần nhất</div>
            <div class="user-show__value"><%= formatDate(detail.updated_at, 'DD/MM/YYYY HH:mm') %></div>
        </div>
        <div class="user-show__row">
            <div class="user-show__label">Người phê duyệt</div>
            <div class="user-show__value"><%= safe(detail.approver_name) %></div>
        </div>
    </section>

    <% if (detail.rejected_reason) { %>
        <div class="user-show__notes">
            <strong>Lý do từ chối:</strong> <%= detail.rejected_reason %>
        </div>
    <% } %>
</div>
